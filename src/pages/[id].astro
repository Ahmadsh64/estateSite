---
import i18next from "../i18n";
import { supabase } from "../lib/supabaseClient";
import type { Property } from "../types/property";  // ייבוא טיפוס Property

const { params } = Astro;
const id = params.id;

let property: Property | null = null; // הגדרת property כ-Property או null

// שליפת הדירה לפי ID מ-Supabase
const { data, error } = await supabase
  .from("properties")
  .select("*")
  .eq("id", id)
  .single();

if (error) {
  console.error("שגיאה בשליפת הדירה:", error.message);
} 
if (data) {
  // המרת הנתונים לטיפוס Property
  property = {
    id: data.id,
    title: data.title,
    price: data.price,
    location: {
      city: data.city || "",
      street: data.street || "",
      number: data.number || "",
      floor: data.floor || "",
    },
    description: data.description || "",
    images: data.images || [],
    occupancy: data.occupancy,
    bedrooms: data.bedrooms,
    beds: data.beds,
    bathrooms: data.bathrooms,
    kitchen: data.kitchen, 
    washingmachine: data.washingmachine,
    wifi: data.wifi,
    tv: data.tv,
    publictransportnearby: data.publictransportnearby,
    parking: data.parking,
    checkintime: data.checkintime,
    checkouttime: data.checkouttime,
    minStayDays: data.minStayDays,
    type: data.type,
    is_active: data.is_active, // הוספת השדה החסר
    created_at: data.created_at,
    has_pool: data.has_pool,            // בריכה
    has_private_pool: data.has_private_pool,    // בריכה פרטית
    has_jacuzzi: data.has_jacuzzi,          // ג'קוזי
    has_grill: data.has_grill,            // מנגל
    suitable_for: data.suitable_for,        // מתאים ל: משפחות, דתיים, קבוצות
    nearby: data.nearby,            // בקרבת המקום: בית כנסת, מסעדות, תחבורה ציבורית
    rating: data.rating,               // דירוג
    reviews_count: data.reviews_count,        // מספר חוות דעת
    phone: data.phone,                // מספר טלפון
    whatsapp: data.whatsapp,             // מספר WhatsApp
  };
}

const images = property ? (Array.isArray(property.images) ? property.images : [property.images]) : [];
---

<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>{property ? property.title : i18next.t("property.notFound")}</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body dir="rtl">
    <header class="detail-header">
      <a href="/" class="detail-back-btn">⬅ {i18next.t("property.backToList")}</a>
    </header>

    <main class="detail-container-fullwidth">
      {property ? (
        <>
          <!-- כותרת הנכס -->
          <div class="property-header-fullwidth">
            <div class="property-title-section">
              <h1 class="property-title-main">{property.title}</h1>
              <div class="property-location-info">
                <span class="location-text">{property.location.city}, {property.location.street}, {property.location.number}</span>
                {property.location.floor && <span class="floor-text"> - {i18next.t("property.floor")} {property.location.floor}</span>}
              </div>
              <div class="property-rating-info">
                <span class="rating-stars">⭐ {property.rating || i18next.t("property.noRating")}</span>
                <span class="rating-text">{i18next.t("property.excellent")}</span>
                <span class="reviews-count">({property.reviews_count || 0} {i18next.t("property.reviews")})</span>
              </div>
            </div>
            <div class="property-contact-buttons">
              <button class="contact-btn-primary" onclick={`window.location.href='tel:${property.phone}'`}>
                📞 {i18next.t("property.call")}
</button>
              <button class="contact-btn-whatsapp" onclick={`window.location.href='https://wa.me/${property.whatsapp}?text=${encodeURIComponent('שלום, אני מעוניין לשאול על הדירה: ' + property.title)}'`}>
                💬 {i18next.t("property.whatsapp")}
              </button>
            </div>
          </div>

          <!-- פריסה ראשית - תמונות ופרטים -->
          <div class="main-content-layout">
            <!-- גלריית תמונות גדולה -->
            <div class="gallery-section">
              <div class="main-image-container-fullwidth">
                <img id="detailMainImage" src={images[0]} alt={property?.title} class="detail-main-image-fullwidth" />
                <div class="image-counter">
                  <span id="currentImageIndex">1</span> / <span id="totalImages">{images.length}</span>
                </div>
              </div>

              <div class="thumbnail-gallery-fullwidth">
                {images.slice(0, 8).map((img, i) => (
                  <img
                    src={img}
                    alt={`תמונה ${i + 1} של ${property?.title}`}
                    class="detail-thumb-fullwidth"
                    data-index={i}
                  />
                ))}
                {images.length > 8 && (
                  <div class="more-images-fullwidth" onclick="openGallery()">+{images.length - 8}</div>
                )}
              </div>

              <!-- פרטי הנכס מתחת לתמונות -->
              <div class="property-details-under-gallery">
                <div class="property-details-card">
                  <h3 class="details-title">{i18next.t("property.details")}</h3>
                  <div class="property-summary">
                    <div class="summary-item">
                      <span class="summary-label">{i18next.t("property.pricePerNight")}:</span>
                      <span class="summary-value">{property.price.toLocaleString("he-IL")} ₪</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">{i18next.t("property.bedrooms")}:</span>
                      <span class="summary-value">{property.bedrooms}</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">{i18next.t("property.bathrooms")}:</span>
                      <span class="summary-value">{property.bathrooms}</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">{i18next.t("property.maxGuests")}:</span>
                      <span class="summary-value">{property.occupancy}</span>
                    </div>
                  </div>
                </div>
              </div>

<!-- סקציות נוספות כמו בוויקנד -->
          <div class="property-sections">
            <!-- תיאור מפורט -->
            <div class="property-description-section">
              <h2 class="section-title">אודות המקום</h2>
              <div class="description-content">
                <p class="property-description-text">{property.description}</p>
              </div>
            </div>

            <!-- מתקנים ופיצ'רים -->
            <div class="amenities-section">
              <h2 class="section-title">מה יש במקום</h2>
              <div class="amenities-grid">
                <div class="amenity-category">
                  <h3 class="amenity-category-title">מתקנים כלליים</h3>
                  <div class="amenity-items">
                    {property.kitchen && <div class="amenity-item">🍳 מטבח</div>}
                    {property.washingmachine && <div class="amenity-item">🧺 מכונת כביסה</div>}
                    {property.wifi && <div class="amenity-item">📶 WiFi</div>}
                    {property.tv && <div class="amenity-item">📺 טלוויזיה</div>}
                    {property.parking && <div class="amenity-item">🅿️ חניה</div>}
                    {property.publictransportnearby && <div class="amenity-item">🚌 תחבורה ציבורית</div>}
                  </div>
                </div>

                <div class="amenity-category">
                  <h3 class="amenity-category-title">מתקנים חיצוניים</h3>
                  <div class="amenity-items">
                    {property.has_pool && <div class="amenity-item">🏊 בריכה</div>}
                    {property.has_private_pool && <div class="amenity-item">🏊‍♀️ בריכה פרטית</div>}
                    {property.has_jacuzzi && <div class="amenity-item">🛁 ג'קוזי</div>}
                    {property.has_grill && <div class="amenity-item">🔥 מנגל</div>}
                  </div>
                </div>

                <div class="amenity-category">
                  <h3 class="amenity-category-title">מתאים ל</h3>
                  <div class="amenity-items">
                    {Array.isArray(property.suitable_for) && property.suitable_for.map((group) => (
                      <div class="amenity-item">👥 {group}</div>
                    ))}
                  </div>
                </div>

                <div class="amenity-category">
                  <h3 class="amenity-category-title">בקרבת מקום</h3>
                  <div class="amenity-items">
                    {Array.isArray(property.nearby) && property.nearby.map((place) => (
                      <div class="amenity-item">📍 {place}</div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            <!-- פרטי שהייה -->
            <div class="stay-details-section">
              <h2 class="section-title">פרטי שהייה</h2>
              <div class="stay-details-grid">
                <div class="stay-detail-item">
                  <span class="stay-detail-label">שעת כניסה:</span>
                  <span class="stay-detail-value">{property.checkintime || "לא צוין"}</span>
                </div>
                <div class="stay-detail-item">
                  <span class="stay-detail-label">שעת יציאה:</span>
                  <span class="stay-detail-value">{property.checkouttime || "לא צוין"}</span>
                </div>
                <div class="stay-detail-item">
                  <span class="stay-detail-label">מינימום לילות:</span>
                  <span class="stay-detail-value">{property.minStayDays || 1} לילות</span>
                </div>
                <div class="stay-detail-item">
                  <span class="stay-detail-label">מקסימום נופשים:</span>
                  <span class="stay-detail-value">{property.occupancy} אנשים</span>
                </div>
              </div>
            </div>

            <!-- פרטי יצירת קשר -->
            <div class="contact-details-section">
              <h2 class="section-title">פרטי יצירת קשר</h2>
              <div class="contact-details-grid">
                <div class="contact-detail-item">
                  <span class="contact-detail-label">טלפון:</span>
                  <span class="contact-detail-value">
                    {property.phone ? (
                      <a href={`tel:${property.phone}`} class="contact-link">{property.phone}</a>
                    ) : (
                      "לא זמין"
                    )}
                  </span>
                </div>
                <div class="contact-detail-item">
                  <span class="contact-detail-label">WhatsApp:</span>
                  <span class="contact-detail-value">
                    {property.whatsapp ? (
                      <a href={`https://wa.me/${property.whatsapp}`} class="contact-link" target="_blank">{property.whatsapp}</a>
                    ) : (
                      "לא זמין"
                    )}
                  </span>
                </div>
              </div>
            </div>
          </div>


            </div>

            <!-- צד ימין - מפה וטופס -->
            <div class="sidebar-section">
              <!-- מפה -->
              <div class="map-card">
                <div class="map-preview-fullwidth" onclick="openGoogleMaps()">
                  <img src="/images/map.png" alt={i18next.t("property.map")} class="map-preview-img-fullwidth" />
                  <div class="map-overlay-text-fullwidth">
                    <span class="map-icon">📍</span>
                    <span>{i18next.t("property.openMap")}</span>
                  </div>
                </div>
              </div>
              
              <!-- טופס יצירת קשר -->
              <div class="contact-form-card">
                <h3 class="contact-form-title">אני רוצה להתארח כאן</h3>
                <form id="sidebarContactForm" class="sidebar-contact-form">
                  <div class="form-group">
                    <label for="full-name-sidebar">שם מלא</label>
                    <input type="text" id="full-name-sidebar" name="full-name" placeholder="הכנס את שמך המלא" required>
                  </div>

                  <div class="form-group">
                    <label for="email-sidebar">כתובת דואר אלקטרוני</label>
                    <input type="email" id="email-sidebar" name="email" placeholder="הכנס את כתובת הדואר האלקטרוני שלך" required>
                  </div>

                  <div class="form-group">
                    <label for="phone-sidebar">מספר טלפון</label>
                    <input type="tel" id="phone-sidebar" name="phone" placeholder="הכנס את מספר הטלפון שלך" required>
                  </div>

                  <div class="form-group">
                    <label for="guests-sidebar">בחירת הרכב</label>
                    <select id="guests-sidebar" name="guests">
                      <option value="1">1 נופש</option>
                      <option value="2" selected>2 נופשים</option>
                      <option value="3">3 נופשים</option>
                      <option value="4">4 נופשים</option>
                      <option value="5">5 נופשים</option>
                      <option value="6">6 נופשים</option>
                      <option value="7">7 נופשים</option>
                      <option value="8">8 נופשים</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="checkin-sidebar">צ'ק-אין</label>
                    <input type="date" id="checkin-sidebar" name="checkin" required>
                  </div>

                  <div class="form-group">
                    <label for="checkout-sidebar">צ'ק-אאוט</label>
                    <input type="date" id="checkout-sidebar" name="checkout" required>
                  </div>

                  <div class="form-group">
                    <label for="special-requests-sidebar">בקשות מיוחדות</label>
                    <textarea id="special-requests-sidebar" name="special-requests" placeholder="מוזמנים להוסיף בקשה למקום האירוח" rows="3"></textarea>
                  </div>

                  <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                      <input type="checkbox" id="offers-sidebar" name="offers">
                      <span class="checkmark"></span>
                      מעוניין לקבל מבצעים בדואר אלקטרוני
                    </label>
                  </div>

                  <button type="submit" class="submit-btn-sidebar">חזרו אלי</button>
                </form>
              </div>
            </div>
          </div>

          

          <!-- כפתורי קשר צפים -->
          <div class="floating-contact-buttons">
            <button class="floating-contact-btn floating-phone-btn" onclick={`window.location.href='tel:${property.phone}'`}>
              <span class="floating-btn-icon">📞</span>
              <span class="floating-btn-text">{i18next.t("property.call")}</span>
            </button>
            <button class="floating-contact-btn floating-whatsapp-btn" onclick={`window.location.href='https://wa.me/${property.whatsapp}?text=${encodeURIComponent('שלום, אני מעוניין לשאול על הדירה: ' + property.title)}'`}>
              <span class="floating-btn-icon">💬</span>
              <span class="floating-btn-text">{i18next.t("property.whatsapp")}</span>
            </button>
          </div>

<!-- מודאל להצגת כל התמונות -->
<div class="gallery-modal" id="galleryModal">
  <div class="gallery-modal-content">
    <span class="close">&times;</span>
    <div class="full-gallery-container">
      <button class="prev-btn">&#10094;</button>
      <div class="full-gallery" id="fullGallery">
        {images.map((img, i) => (
          <img
            src={img}
            alt={`תמונה ${i + 1} של ${property?.title}`}
            class="gallery-image"
            data-index={i}
          />
        ))}
      </div>
      <button class="next-btn">&#10095;</button>
    </div>
  </div>
</div>

<!-- מודאל למפה -->
<div class="map-modal" id="mapModal">
  <div class="map-modal-content">
    <span class="close-map">&times;</span>
    <div class="map-container">
      <iframe 
        src={`https://www.google.com/maps/embed/v1/place?key=YOUR_API_KEY&q=${property.location.city}+${property.location.street}+${property.location.number}`}
        width="100%" 
        height="100%" 
        style="border:0;" 
        allowfullscreen="" 
        loading="lazy" 
        referrerpolicy="no-referrer-when-downgrade">
      </iframe>
              </div>
            </div>
          </div>

          

          <!-- טופס יצירת קשר -->
        </>
      ) : (
        <p class="detail-not-found">{i18next.t("property.notFound")}</p>
      )}
    </main>
    <script type="module">
      let currentImageIndex = 0;

      function changeImage(direction) {
        const images = document.querySelectorAll('.full-gallery img');
        currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
        const newScrollPosition = images[currentImageIndex].offsetLeft;
        document.getElementById('fullGallery').scrollTo({
          left: newScrollPosition,
          behavior: 'smooth'
        });
      }

      function openGallery() {
        const fullScreenModal = document.getElementById("galleryModal");
        if (fullScreenModal) {
          fullScreenModal.style.display = "flex";
        }
      }

      function closeGallery() {
        const fullScreenModal = document.getElementById("galleryModal");
        if (fullScreenModal) {
          fullScreenModal.style.display = "none";
        }
      }

      function openMapOverlay() {
        const mapModal = document.getElementById("mapModal");
        if (mapModal) {
          mapModal.style.display = "flex";
        }
      }

      function closeMapOverlay() {
        const mapModal = document.getElementById("mapModal");
        if (mapModal) {
          mapModal.style.display = "none";
        }
      }

      // פונקציה לפתיחת מפה ב-Google Maps
      function openGoogleMaps() {
        const city = "{property.location.city}";
        const street = "{property.location.street}";
        const number = "{property.location.number}";
        const address = `${city}+${street}`;
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        window.open(mapsUrl, '_blank');
      }

      function updateImageCounter(index) {
        const currentIndexElement = document.getElementById("currentImageIndex");
        if (currentIndexElement) {
          currentIndexElement.textContent = index + 1;
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        function changeImageMain(event) {
          const newImageSrc = event.target.src;
          const mainImage = document.getElementById("detailMainImage");
          const imageIndex = parseInt(event.target.getAttribute("data-index"));
          
          if (mainImage) {
            mainImage.src = newImageSrc;
            currentImageIndex = imageIndex;
            updateImageCounter(imageIndex);
          }
        }

        // חיבור לתמונות הקטנות
        const thumbs = document.querySelectorAll(".detail-thumb-fullwidth");
        thumbs.forEach(thumb => {
          thumb.addEventListener("click", changeImageMain);
        });

        // חיבור לתמונה הראשית
        const mainImage = document.getElementById("detailMainImage");
        if (mainImage) {
          mainImage.addEventListener("click", openGallery);
        }

        // כפתור "עוד תמונות"
        const moreImagesButton = document.querySelector(".more-images-fullwidth");
        if (moreImagesButton) {
          moreImagesButton.addEventListener("click", openGallery);
        }

        // כפתורי ניווט במודאל
        const prevButton = document.querySelector(".prev-btn");
        const nextButton = document.querySelector(".next-btn");

        if (prevButton) {
          prevButton.addEventListener("click", function() {
            changeImage(-1);
          });
        }

        if (nextButton) {
          nextButton.addEventListener("click", function() {
            changeImage(1);
          });
        }

        // כפתור סגירת גלריה
        const closeButton = document.querySelector(".close");
        if (closeButton) {
          closeButton.addEventListener("click", closeGallery);
        }
        
        // כפתור סגירת מפה
        const closeMapButton = document.querySelector(".close-map");
        if (closeMapButton) {
          closeMapButton.addEventListener("click", closeMapOverlay);
        }

        // סגירת מודאלים בלחיצה מחוץ לתוכן
        const galleryModal = document.getElementById("galleryModal");
        const mapModal = document.getElementById("mapModal");

        if (galleryModal) {
          galleryModal.addEventListener("click", function(e) {
            if (e.target === galleryModal) {
              closeGallery();
            }
          });
        }

        if (mapModal) {
          mapModal.addEventListener("click", function(e) {
            if (e.target === mapModal) {
              closeMapOverlay();
            }
          });
        }

        // הוספת הפונקציות לגלובל
        window.openGoogleMaps = openGoogleMaps;
        window.openMapOverlay = openMapOverlay;

        // אנימציה לכפתורים הצפים
        const floatingButtons = document.querySelectorAll('.floating-contact-btn');
        floatingButtons.forEach((button, index) => {
          // אנימציה של הופעה
          button.style.opacity = '0';
          button.style.transform = 'translateY(50px)';
          
          setTimeout(() => {
            button.style.transition = 'all 0.5s ease';
            button.style.opacity = '1';
            button.style.transform = 'translateY(0)';
          }, 500 + (index * 200));
          
          // אנימציה של רטט
          button.addEventListener('mouseenter', function() {
            this.style.animation = 'pulse 0.6s ease-in-out';
          });
          
          button.addEventListener('animationend', function() {
            this.style.animation = '';
          });
        });

        // טיפול בטופס יצירת קשר
        const sidebarContactForm = document.getElementById("sidebarContactForm");
        if (sidebarContactForm) {
          sidebarContactForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const formData = new FormData(sidebarContactForm);
            const data = Object.fromEntries(formData.entries());
            
            // הוספת פרטי הנכס
            data.propertyId = "{property.id}";
            data.propertyTitle = "{property.title}";
            data.propertyPrice = "{property.price}";
            
            try {
              // כאן תוכל להוסיף שליחה לשרת
              console.log("טופס נשלח:", data);
              
              // הודעת הצלחה
              alert("תודה! פנייתך נשלחה בהצלחה. נחזור אליך בהקדם.");
              sidebarContactForm.reset();
              
            } catch (error) {
              console.error("שגיאה בשליחת הטופס:", error);
              alert("אירעה שגיאה בשליחת הפנייה. אנא נסה שוב.");
            }
          });
        }
      });
    </script>
  </body>
</html>