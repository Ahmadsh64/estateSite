---
import i18next from "../i18n";
import { supabase } from "../lib/supabaseClient";
import type { Property } from "../types/property";  // ×™×™×‘×•× ×˜×™×¤×•×¡ Property

const { params } = Astro;
const id = params.id;

let property: Property | null = null; // ×”×’×“×¨×ª property ×›-Property ××• null

// ×©×œ×™×¤×ª ×”×“×™×¨×” ×œ×¤×™ ID ×-Supabase
const { data, error } = await supabase
  .from("properties")
  .select("*")
  .eq("id", id)
  .single();

if (error) {
  console.error("×©×’×™××” ×‘×©×œ×™×¤×ª ×”×“×™×¨×”:", error.message);
} 
if (data) {
  // ×”××¨×ª ×”× ×ª×•× ×™× ×œ×˜×™×¤×•×¡ Property
  property = {
    id: data.id,
    title: data.title,
    price: data.price,
    location: {
      city: data.city || "",
      street: data.street || "",
      number: data.number || "",
      floor: data.floor || "",
    },
    description: data.description || "",
    images: data.images || [],
    occupancy: data.occupancy,
    bedrooms: data.bedrooms,
    beds: data.beds,
    bathrooms: data.bathrooms,
    kitchen: data.kitchen, 
    washingmachine: data.washingmachine,
    wifi: data.wifi,
    tv: data.tv,
    publictransportnearby: data.publictransportnearby,
    parking: data.parking,
    checkintime: data.checkintime,
    checkouttime: data.checkouttime,
    minStayDays: data.minStayDays,
    type: data.type,
    is_active: data.is_active, // ×”×•×¡×¤×ª ×”×©×“×” ×”×—×¡×¨
    created_at: data.created_at,
    has_pool: data.has_pool,            // ×‘×¨×™×›×”
    has_private_pool: data.has_private_pool,    // ×‘×¨×™×›×” ×¤×¨×˜×™×ª
    has_jacuzzi: data.has_jacuzzi,          // ×’'×§×•×–×™
    has_grill: data.has_grill,            // ×× ×’×œ
    suitable_for: data.suitable_for,        // ××ª××™× ×œ: ××©×¤×—×•×ª, ×“×ª×™×™×, ×§×‘×•×¦×•×ª
    nearby: data.nearby,            // ×‘×§×¨×‘×ª ×”××§×•×: ×‘×™×ª ×›× ×¡×ª, ××¡×¢×“×•×ª, ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª
    rating: data.rating,               // ×“×™×¨×•×’
    reviews_count: data.reviews_count,        // ××¡×¤×¨ ×—×•×•×ª ×“×¢×ª
    phone: data.phone,                // ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
    whatsapp: data.whatsapp,             // ××¡×¤×¨ WhatsApp
  };
}

const images = property ? (Array.isArray(property.images) ? property.images : [property.images]) : [];
---

<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>{property ? property.title : i18next.t("property.notFound")}</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body dir="rtl">
    <header class="detail-header">
      <a href="/" class="detail-back-btn">â¬… {i18next.t("property.backToList")}</a>
    </header>

    <main class="detail-container">
      {property ? (
        <>
          <div class="detail-header-bar">
            <div class="detail-header-right">
              <h1>{property.title}</h1>
              <p class="detail-location">{property.location.city}, {property.location.street}, {property.location.number} - {i18next.t("property.floor")} {property.location.floor}</p>
              <p class="detail-rating">
                â­ {property.rating || i18next.t("property.noRating")} {i18next.t("property.excellent")} ({property.reviews_count || 0} {i18next.t("property.reviews")})
              </p>
              <p class="detail-summary">
                {i18next.t("property.bedrooms")}: {property.bedrooms} | {i18next.t("property.bathrooms")}: {property.bathrooms} | {i18next.t("property.maxGuests")}: {property.occupancy}
              </p>
            </div>
            <div class="detail-header-left">
              <button class="contact-btn" onclick="window.location.href='tel:{property.phone}'">ğŸ“ {property.phone}</button>
              <button class="contact-btn" onclick="window.location.href='https://wa.me/{property.whatsapp}'">{i18next.t("property.whatsapp")}</button>
            </div>
          </div>

          <div class="detail-gallery-map">
            <div class="detail-gallery">
              <img id="detailMainImage" src={property.images[0]} alt={property.title} class="detail-main-image" />
              <div class="detail-thumbs">
                {property.images && Array.isArray(property.images) ? (
                  property.images.map((img, i) => (
                    <img
                      src={img}
                      alt={`×ª××•× ×” ${i+1} ×©×œ ${property.title}`}
                      class="detail-thumb"
                      id={`thumb-${i}`}
                    />
                  ))
                ) : (
                  <p>{i18next.t("property.noImages")}</p>
                )}
              </div>
            </div>
            <div class="map-box">
              <div class="map-item">
                <img src="/images/map.png" alt={i18next.t("property.map")} title={i18next.t("property.map")} />
                <button class="map-btn-expand" onclick="window.open('https://www.google.com/maps?q={property.location.city}+{property.location.street}', '_blank')">
                  {i18next.t("property.openMap")}
                </button>
              </div>
            </div>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.details")}</h3>
            <p class="detail-description">{property.description}</p>
            <ul class="detail-info-list">
              <li><strong>{i18next.t("property.pricePerNight")}:</strong> {property.price} â‚ª</li>
              <li><strong>{i18next.t("property.propertyType")}:</strong> {property.type}</li>
              <li><strong>{i18next.t("property.location")}:</strong> {property.location.city}, {property.location.street} {property.location.number}, {i18next.t("property.floor")} {property.location.floor}</li>
              <li><strong>{i18next.t("property.maxGuests")}:</strong> {property.occupancy}</li>
              <li><strong>{i18next.t("property.bedrooms")}:</strong> {property.bedrooms}</li>
              <li><strong>{i18next.t("property.beds")}:</strong> {property.beds}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.features")}</h3>
            <h4>{i18next.t("property.general")}</h4>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.maxGuests")}:</strong> {property.occupancy}</li>
              <li><strong>{i18next.t("property.bedrooms")}:</strong> {property.bedrooms}</li>
              <li><strong>{i18next.t("property.beds")}:</strong> {property.beds}</li>
              <li><strong>{i18next.t("property.bathrooms")}:</strong> {property.bathrooms}</li>
              <li><strong>{i18next.t("property.kitchen")}:</strong> {property.kitchen ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.washingmachine")}:</strong> {property.washingmachine ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.wifi")}:</strong> {property.wifi ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.tv")}:</strong> {property.tv ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.publictransportnearby")}</strong> {property.publictransportnearby ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.parking")}:</strong> {property.parking ? "âœ”ï¸" : "âŒ"}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.outdoorFacilities")}</h3>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.privatePool")}:</strong> {property.has_private_pool ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.sharedPool")}:</strong> {property.has_pool ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.jacuzzi")}:</strong> {property.has_jacuzzi ? "âœ”ï¸" : "âŒ"}</li>
              <li><strong>{i18next.t("property.grill")}:</strong> {property.has_grill ? "âœ”ï¸" : "âŒ"}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h4>{i18next.t("property.suitableFor")}</h4>
            <ul class="feature-list">
              {Array.isArray(property.suitable_for) && property.suitable_for.map((group, i) => (
                <li>{group}</li>
              ))}
            </ul>
          </div>

          <div class="detail-info-box">
            <h4>{i18next.t("property.nearby")}</h4>
            <ul class="feature-list">
              {Array.isArray(property.nearby) && property.nearby.map((group, i) => (
                <li>{group}</li>
              ))}
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.contactInfo")}</h3>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.phone")}:</strong> {property.phone || i18next.t("property.notAvailable")}</li>
              <li><strong>{i18next.t("property.whatsapp")}:</strong> {property.whatsapp || i18next.t("property.notAvailable")}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.terms")}</h3>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.checkintime")}:</strong> {property.checkintime || i18next.t("property.notSpecified")}</li>
              <li><strong>{i18next.t("property.checkouttime")}:</strong> {property.checkouttime || i18next.t("property.notSpecified")}</li>
              <li><strong>{i18next.t("property.minstaydays")}:</strong> {property.minStayDays || 0}</li>
            </ul>
          </div>

          <!-- ×˜×•×¤×¡ ×™×¦×™×¨×ª ×§×©×¨ -->
<div class="contact-form">
            <h3>×× ×™ ×¨×•×¦×” ×œ×”×ª××¨×— ×›××Ÿ</h3>
            <form action="#" method="POST">
              <label for="full-name">×©× ××œ×</label>
              <input type="text" id="full-name" name="full-name" placeholder="×”×›× ×¡ ××ª ×©××š ×”××œ×" required>

              <label for="email">×›×ª×•×‘×ª ×“×•××¨ ××œ×§×˜×¨×•× ×™</label>
              <input type="email" id="email" name="email" placeholder="×”×›× ×¡ ××ª ×›×ª×•×‘×ª ×”×“×•××¨ ×”××œ×§×˜×¨×•× ×™ ×©×œ×š" required>

              <label for="phone">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
              <input type="tel" id="phone" name="phone" placeholder="×”×›× ×¡ ××ª ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ×©×œ×š" required>

              <label for="guests">×‘×—×™×¨×ª ×”×¨×›×‘</label>
              <select id="guests" name="guests">
                <option value="2">2 × ×•×¤×©×™×</option>
                <option value="3">3 × ×•×¤×©×™×</option>
                <option value="4">4 × ×•×¤×©×™×</option>
                <option value="5">5 × ×•×¤×©×™×</option>
              </select>

              <label for="checkin">×¦'×§-××™×Ÿ</label>
              <input type="date" id="checkin" name="checkin" required>

              <label for="checkout">×¦'×§-×××•×˜</label>
              <input type="date" id="checkout" name="checkout" required>

              <label for="special-requests">×‘×§×©×•×ª ××™×•×—×“×•×ª</label>
              <textarea id="special-requests" name="special-requests" placeholder="××•×–×× ×™× ×œ×”×•×¡×™×£ ×‘×§×©×” ×œ××§×•× ×”××™×¨×•×—"></textarea>

              <label for="offers">××¢×•× ×™×™×Ÿ ×œ×§×‘×œ ××‘×¦×¢×™× ×‘×“×•××¨ ××œ×§×˜×¨×•× ×™</label>
              <input type="checkbox" id="offers" name="offers">

              <button type="submit" class="submit-btn">×—×–×¨×• ××œ×™</button>
            </form>
          </div>
        </>
      ) : (
        <p class="detail-not-found">{i18next.t("property.notFound")}</p>
      )}
    </main>
 <script type="module">
  document.addEventListener("DOMContentLoaded", function () {
    // ×¤×•× ×§×¦×™×” ×œ×”×—×œ×¤×ª ×ª××•× ×” ×¨××©×™×ª ×‘×œ×—×™×¦×” ×¢×œ ×ª××•× ×” ×§×˜× ×”
    function changeImage(event) {
      const newImageSrc = event.target.src;
      const mainImage = document.getElementById("detailMainImage");
      if (mainImage) { // ×•×•×“× ×©×”××œ×× ×˜ ×§×™×™×
        mainImage.src = newImageSrc;
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×ª××•× ×” ×‘×’×•×“×œ ××œ× ×‘×œ×—×™×¦×” ×¢×œ ×”×ª××•× ×” ×”×¨××©×™×ª
    function openFullScreen() {
      const mainImage = document.getElementById("detailMainImage");
      const fullScreenModal = document.getElementById("fullScreenModal");
      const fullScreenImage = document.getElementById("fullScreenImage");

      if (mainImage && fullScreenModal && fullScreenImage) { // ×‘×“×•×§ ×× ×›×œ ×”××œ×× ×˜×™× ×§×™×™××™×
        fullScreenImage.src = mainImage.src;
        fullScreenModal.style.display = "flex";
      }
    }

    // ×¡×’×•×¨ ××ª ×—×œ×•×Ÿ ×”×ª××•× ×” ×”×’×“×•×œ×” ×‘×œ×—×™×¦×” ×¢×œ ×”-X
    function closeFullScreen() {
      const fullScreenModal = document.getElementById("fullScreenModal");
      if (fullScreenModal) { // ×‘×“×•×§ ×× ×”××•×“××œ ×§×™×™×
        fullScreenModal.style.display = "none";
      }
    }

    // ×××–×™× ×™× ×œ××™×¨×•×¢×™× ×œ×ª××•× ×•×ª ××™× ×™
    const thumbs = document.querySelectorAll(".detail-thumb");
    if (thumbs.length > 0) { // ×‘×“×•×§ ×× ×™×© ×ª××•× ×•×ª ××™× ×™
      thumbs.forEach(thumb => {
        thumb.addEventListener("click", changeImage);
      });
    }

    // ×××–×™×Ÿ ×œ××™×¨×•×¢×™× ×œ×ª××•× ×” ×”×¨××©×™×ª
    const mainImage = document.getElementById("detailMainImage");
    if (mainImage) { // ×× ×”×ª××•× ×” ×”×¨××©×™×ª ×§×™×™××ª
      mainImage.addEventListener("click", openFullScreen);
    }

    // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×›×¤×ª×•×¨ ×¡×’×™×¨×” ×©×œ ×”××•×“××œ
    const modalClose = document.getElementById("modalClose");
    if (modalClose) { // ×× ×›×¤×ª×•×¨ ×”×¡×’×™×¨×” ×§×™×™×
      modalClose.addEventListener("click", closeFullScreen);
    }

    // ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×›×¤×ª×•×¨×™× ×©×œ ×™×¦×™×¨×ª ×§×©×¨
    const phoneButton = document.getElementById("phoneButton");
    if (phoneButton) { // ×× ×›×¤×ª×•×¨ ×”×˜×œ×¤×•×Ÿ ×§×™×™×
      phoneButton.addEventListener("click", function () {
        window.location.href = `tel:${property.phone}`;
      });
    }

    const whatsappButton = document.getElementById("whatsappButton");
    if (whatsappButton) { // ×× ×›×¤×ª×•×¨ ×”-WhatsApp ×§×™×™×
      whatsappButton.addEventListener("click", function () {
        window.location.href = `https://wa.me/${property.whatsapp}`;
      });
    }
  });
</script>

  </body>
</html>

