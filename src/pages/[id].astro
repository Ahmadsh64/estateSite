---
import i18next from "../i18n.js";
import { supabase } from "../lib/supabaseClient";
import type { Property } from "../types/property";  // ייבוא טיפוס Property
import { mapDbToProperty } from "../services/propertyMapper";  // ייבוא פונקציית המרה

// פונקציה עזר להוספת קידומת מדינה
function formatPhoneNumber(phone: string | undefined): string {
  if (!phone) return '';
  if (phone.startsWith('+')) return phone;
  return '+972' + phone.replace(/^0/, '');
}

const { params } = Astro;
const id = params.id;

let property: Property | null = null; // הגדרת property כ-Property או null

// שליפת הדירה לפי ID מ-Supabase
const { data, error } = await supabase
  .from("properties")
  .select("*")
  .eq("id", id)
  .single();

if (error) {
  console.error(i18next.t("common.errors.errorLoadingProperty"), error.message);
} 
if (data) {
  // המרת הנתונים לטיפוס Property באמצעות הפונקציה
  property = mapDbToProperty(data);
}

const images = property ? (Array.isArray(property.images) ? property.images : [property.images]) : [];
---

<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>{property ? property.title : i18next.t("property.notFound")}</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body dir="rtl">
    <header class="detail-header">
      <a href="/" class="detail-back-btn">⬅ {i18next.t("property.backToList")}</a>
    </header>

    <main class="detail-container-fullwidth">
      {property ? (
        <>
          <!-- כותרת הנכס -->
          <div class="property-header-fullwidth">
            <div class="property-title-section">
              <h1 class="property-title-main">{property.title}</h1>
              <div class="property-location-info">
                <span class="location-text">{property.location.city}, {property.location.street}, {property.location.number}</span>
                {property.location.floor && <span class="floor-text"> - {i18next.t("property.floor")} {property.location.floor}</span>}
              </div>
              <div class="property-rating-info">
                <span class="rating-stars">⭐ {property.rating || i18next.t("property.noRating")}</span>
                <span class="rating-text">{i18next.t("property.excellent")}</span>
                <span class="reviews-count">({property.reviews_count || 0} {i18next.t("property.reviews")})</span>
              </div>
            </div>
            <div class="property-contact-buttons">
              <button class="contact-btn-primary" onclick={`window.location.href='tel:${formatPhoneNumber(property.phone)}'`}>
                📞 {i18next.t("property.call")}
              </button>
              <a href={`https://wa.me/${formatPhoneNumber(property.whatsapp)}?text=${encodeURIComponent(i18next.t("property.whatsappMessage") + ' ' + property.title)}`} class="contact-btn-whatsapp" target="_blank" rel="noopener noreferrer">
                💬 {i18next.t("property.whatsapp")}
              </a>
            </div>
          </div>

          <!-- פריסה ראשית - תמונות ופרטים -->
          <div class="main-content-layout">
            <!-- גלריית תמונות גדולה -->
            <div class="gallery-section">
              <div class="main-image-container-fullwidth">
                <img id="detailMainImage" src={images[0]} alt={property?.title} class="detail-main-image-fullwidth" />
                <div class="image-counter">
                  <span id="currentImageIndex">1</span> / <span id="totalImages">{images.length}</span>
                </div>
              </div>

              <div class="thumbnail-gallery-fullwidth">
                {images.slice(0, 8).map((img, i) => (
                  <img
                    src={img}
                    alt={`תמונה ${i + 1} של ${property?.title}`}
                    class="detail-thumb-fullwidth"
                    data-index={i}
                  />
                ))}
                {images.length > 8 && (
                  <div class="more-images-fullwidth" onclick="openGallery()">+{images.length - 8}</div>
                )}
              </div>

                <!-- פרטי הנכס מתחת לתמונות -->
                <div class="property-details-under-gallery">
                  <div class="property-details-card">
                    <h3 class="details-title">{i18next.t("property.details")}</h3>
                    <div class="property-summary">
                      <div class="summary-item">
                        <span class="summary-label">{i18next.t("property.pricePerNight")}:</span>
                        <span class="summary-value">{property.price.toLocaleString("he-IL")} ₪</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">{i18next.t("property.bedrooms")}:</span>
                        <span class="summary-value">{property.bedrooms}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">{i18next.t("property.bathrooms")}:</span>
                        <span class="summary-value">{property.bathrooms}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">{i18next.t("property.maxGuests")}:</span>
                        <span class="summary-value">{property.occupancy}</span>
                      </div>
                    </div>
                  </div>

                  <!-- תיאור מפורט -->
                  <div class="property-description-section">
                    <h2 class="section-title">{i18next.t("property.aboutPlace")}</h2>
                    <div class="description-content">
                      <p class="property-description-text">{property.description}</p>
                    </div>
                  </div>

                  <!-- מתקנים ופיצ'רים -->
                  <div class="amenities-section">
                    <h2 class="section-title">{i18next.t("property.amenities")}</h2>
                    <div class="amenities-grid">
                      <div class="amenity-category">
                        <h3 class="amenity-category-title">{i18next.t("property.generalFacilities")}</h3>
                        <div class="amenity-items">
                          {property.kitchen && <div class="amenity-item">🍳 {i18next.t("property.kitchen")}</div>}
                          {property.washingmachine && <div class="amenity-item">🧺 {i18next.t("property.washingMachine")}</div>}
                          {property.wifi && <div class="amenity-item">📶 WiFi</div>}
                          {property.tv && <div class="amenity-item">📺 {i18next.t("property.tv")}</div>}
                          {property.parking && <div class="amenity-item">🅿️ {i18next.t("property.parking")}</div>}
                          {property.publictransportnearby && <div class="amenity-item">🚌 {i18next.t("property.publicTransport")}</div>}
                        </div>
                      </div>

                      <div class="amenity-category">
                        <h3 class="amenity-category-title">{i18next.t("property.outdoorFacilities")}</h3>
                        <div class="amenity-items">
                          {property.has_pool && <div class="amenity-item">🏊 {i18next.t("property.pool")}</div>}
                          {property.has_private_pool && <div class="amenity-item">🏊‍♀️ {i18next.t("property.privatePool")}</div>}
                          {property.has_jacuzzi && <div class="amenity-item">🛁 {i18next.t("property.jacuzzi")}</div>}
                          {property.has_grill && <div class="amenity-item">🔥 {i18next.t("property.grill")}</div>}
                        </div>
                      </div>

                      <div class="amenity-category">
                        <h3 class="amenity-category-title">{i18next.t("property.suitableFor")}</h3>
                        <div class="amenity-items">
                          {Array.isArray(property.suitable_for) && property.suitable_for.map((group) => (
                            <div class="amenity-item">👥 {group}</div>
                          ))}
                        </div>
                      </div>

                      <div class="amenity-category">
                        <h3 class="amenity-category-title">{i18next.t("property.nearby")}</h3>
                        <div class="amenity-items">
                          {Array.isArray(property.nearby) && property.nearby.map((place) => (
                            <div class="amenity-item">📍 {place}</div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- פרטי שהייה -->
                  <div class="stay-details-section">
                    <h2 class="section-title">{i18next.t("property.stayDetails")}</h2>
                    <div class="stay-details-grid">
                      <div class="stay-detail-item">
                        <span class="stay-detail-label">{i18next.t("property.checkInTime")}:</span>
                        <span class="stay-detail-value">{property.checkintime || i18next.t("common.notSpecified")}</span>
                      </div>
                      <div class="stay-detail-item">
                        <span class="stay-detail-label">{i18next.t("property.checkOutTime")}:</span>
                        <span class="stay-detail-value">{property.checkouttime || i18next.t("common.notSpecified")}</span>
                      </div>
                      <div class="stay-detail-item">
                        <span class="stay-detail-label">{i18next.t("property.minimumNights")}:</span>
                        <span class="stay-detail-value">{property.minStayDays || 1} {i18next.t("property.nights")}</span>
                      </div>
                      <div class="stay-detail-item">
                        <span class="stay-detail-label">{i18next.t("property.maximumGuests")}:</span>
                        <span class="stay-detail-value">{property.occupancy} {i18next.t("property.people")}</span>
                      </div>
                    </div>
                  </div>

                  <!-- פרטי יצירת קשר -->
                  <div class="contact-details-section">
                    <h2 class="section-title">{i18next.t("property.contactDetails")}</h2>
                    <div class="contact-details-grid">
                      <div class="contact-detail-item">
                        <span class="contact-detail-label">{i18next.t("property.phone")}:</span>
                        <span class="contact-detail-value">
                          {property.phone ? (
                            <a href={`tel:${formatPhoneNumber(property.phone)}`} class="contact-link">{property.phone}</a>
                          ) : (
                            i18next.t("common.notAvailable")
                          )}
                        </span>
                      </div>
                      <div class="contact-detail-item">
                        <span class="contact-detail-label">WhatsApp:</span>
                        <span class="contact-detail-value">
                          {property.whatsapp ? (
                            <a href={`https://wa.me/${formatPhoneNumber(property.whatsapp)}`} class="contact-link" target="_blank">{property.whatsapp}</a>
                          ) : (
                            i18next.t("common.notAvailable")
                          )}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>



            </div>

            <!-- צד ימין - מפה וטופס -->
            <div class="sidebar-section">
              <!-- מפה -->
              <div class="map-card">
                <div class="map-preview-fullwidth" onclick="openGoogleMaps()">
                  <img src="/images/map.png" alt={i18next.t("property.map")} class="map-preview-img-fullwidth" />
                  <div class="map-overlay-text-fullwidth">
                    <span class="map-icon">📍</span>
                    <span>{i18next.t("property.openMap")}</span>
                  </div>
                </div>
              </div>
              
              <!-- טופס יצירת קשר -->
              <div class="contact-form-card">
                <h3 class="contact-form-title">{i18next.t("property.contactForm")}</h3>
                <form id="sidebarContactForm" class="sidebar-contact-form">
                  <!-- Hidden fields for property data -->
                  <input type="hidden" name="propertyId" value={property.id}>
                  <input type="hidden" name="propertyTitle" value={property.title}>
                  <input type="hidden" name="propertyPrice" value={property.price}>
                  
                  <div class="form-group">
                    <label for="full-name-sidebar">{i18next.t("property.fullName")}</label>
                    <input type="text" id="full-name-sidebar" name="full-name" placeholder={i18next.t("property.enterFullName")} required>
                  </div>

                  <div class="form-group">
                    <label for="email-sidebar">{i18next.t("property.email")}</label>
                    <input type="email" id="email-sidebar" name="email" placeholder={i18next.t("property.enterEmail")} required>
                  </div>

                  <div class="form-group">
                    <label for="phone-sidebar">{i18next.t("property.call")}</label>
                    <input type="tel" id="phone-sidebar" name="phone" placeholder={i18next.t("property.enterPhone")} required>
                  </div>

                  <div class="form-group">
                    <label for="guests-sidebar">{i18next.t("property.selectGuests")}</label>
                    <select id="guests-sidebar" name="guests">
                      <option value="1">1 {i18next.t("property.guest")}</option>
                      <option value="2" selected>2 {i18next.t("property.guests")}</option>
                      <option value="3">3 {i18next.t("property.guests")}</option>
                      <option value="4">4 {i18next.t("property.guests")}</option>
                      <option value="5">5 {i18next.t("property.guests")}</option>
                      <option value="6">6 {i18next.t("property.guests")}</option>
                      <option value="7">7 {i18next.t("property.guests")}</option>
                      <option value="8">8 {i18next.t("property.guests")}</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="checkin-sidebar">{i18next.t("property.checkintime")}</label>
                    <input type="date" id="checkin-sidebar" name="checkin" required>
                  </div>

                  <div class="form-group">
                    <label for="checkout-sidebar">{i18next.t("property.checkouttime")}</label>
                    <input type="date" id="checkout-sidebar" name="checkout" required>
                  </div>

                  <div class="form-group">
                    <label for="special-requests-sidebar">{i18next.t("property.specialRequests")}</label>
                    <textarea id="special-requests-sidebar" name="special-requests" placeholder={i18next.t("property.specialRequestsPlaceholder")} rows="3"></textarea>
                  </div>

                  <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                      <input type="checkbox" id="offers-sidebar" name="offers">
                      <span class="checkmark"></span>
                      {i18next.t("property.receiveOffers")}
                    </label>
                  </div>

                  <button type="submit" class="submit-btn-sidebar">{i18next.t("property.submitButton")}</button>
                </form>
              </div>
            </div>
          </div>

          

          <!-- כפתורי קשר צפים -->
          <div class="floating-contact-buttons">
            <button class="floating-contact-btn floating-phone-btn" onclick={`window.location.href='tel:${formatPhoneNumber(property.phone)}'`}>
              <span class="floating-btn-icon">📞</span>
              <span class="floating-btn-text">{i18next.t("property.call")}</span>
            </button>
            <a href={`https://wa.me/${formatPhoneNumber(property.whatsapp)}?text=${encodeURIComponent(i18next.t("property.whatsappMessage") + ' ' + property.title)}`} class="floating-contact-btn floating-whatsapp-btn" target="_blank" rel="noopener noreferrer">
              <span class="floating-btn-icon">💬</span>
              <span class="floating-btn-text">{i18next.t("property.whatsapp")}</span>
            </a>
          </div>

<!-- מודאל להצגת כל התמונות -->
<div class="gallery-modal" id="galleryModal">
  <div class="gallery-modal-content">
    <span class="close">&times;</span>
    <div class="full-gallery-container">
      <button class="prev-btn">&#10094;</button>
      <div class="full-gallery" id="fullGallery">
        {images.map((img, i) => (
          <img
            src={img}
            alt={`תמונה ${i + 1} של ${property?.title}`}
            class="gallery-image"
            data-index={i}
          />
        ))}
      </div>
      <button class="next-btn">&#10095;</button>
    </div>
  </div>
</div>

<!-- מודאל למפה -->
<div class="map-modal" id="mapModal">
  <div class="map-modal-content">
    <span class="close-map">&times;</span>
    <div class="map-container">
      <iframe 
        src={`https://www.google.com/maps/embed/v1/place?key=YOUR_API_KEY&q=${encodeURIComponent(`${property.location.street} ${property.location.number}, ${property.location.city}`)}`}
        width="100%" 
        height="100%" 
        style="border:0;" 
        allowfullscreen="" 
        loading="lazy" 
        referrerpolicy="no-referrer-when-downgrade">
      </iframe>
              </div>
            </div>
          </div>

          

          <!-- טופס יצירת קשר -->
        </>
      ) : (
        <p class="detail-not-found">{i18next.t("property.notFound")}</p>
      )}
    </main>
    <script type="module">
      let currentImageIndex = 0;

      function changeImage(direction) {
        const images = document.querySelectorAll('.full-gallery img');
        currentImageIndex = (currentImageIndex + direction + images.length) % images.length;
        const newScrollPosition = images[currentImageIndex].offsetLeft;
        document.getElementById('fullGallery').scrollTo({
          left: newScrollPosition,
          behavior: 'smooth'
        });
      }

      function openGallery() {
        const fullScreenModal = document.getElementById("galleryModal");
        if (fullScreenModal) {
          fullScreenModal.style.display = "flex";
        }
      }

      function closeGallery() {
        const fullScreenModal = document.getElementById("galleryModal");
        if (fullScreenModal) {
          fullScreenModal.style.display = "none";
        }
      }

      function openMapOverlay() {
        const mapModal = document.getElementById("mapModal");
        if (mapModal) {
          mapModal.style.display = "flex";
        }
      }

      function closeMapOverlay() {
        const mapModal = document.getElementById("mapModal");
        if (mapModal) {
          mapModal.style.display = "none";
        }
      }

      // פונקציה לפתיחת מפה ב-Google Maps
      function openGoogleMaps() {
        const city = "{property.location.city}";
        const street = "{property.location.street}";
        const number = "{property.location.number}";
        const floor = "{property.location.floor}";
        
        // בניית כתובת מלאה
        let address = "";
        if (street) address += street;
        if (number) address += ` ${number}`;
        if (floor) address += `, ${floor}`;
        if (city) address += `, ${city}`;
        
        // אם אין כתובת, נשתמש רק בעיר
        if (!address.trim()) {
          address = city || i18next.t("property.israel");
        }
        
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        window.open(mapsUrl, '_blank');
      }

      function updateImageCounter(index) {
        const currentIndexElement = document.getElementById("currentImageIndex");
        if (currentIndexElement) {
          currentIndexElement.textContent = index + 1;
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        function changeImageMain(event) {
          const newImageSrc = event.target.src;
          const mainImage = document.getElementById("detailMainImage");
          const imageIndex = parseInt(event.target.getAttribute("data-index"));
          
          if (mainImage) {
            mainImage.src = newImageSrc;
            currentImageIndex = imageIndex;
            updateImageCounter(imageIndex);
          }
        }

        // חיבור לתמונות הקטנות
        const thumbs = document.querySelectorAll(".detail-thumb-fullwidth");
        thumbs.forEach(thumb => {
          thumb.addEventListener("click", changeImageMain);
        });

        // חיבור לתמונה הראשית
        const mainImage = document.getElementById("detailMainImage");
        if (mainImage) {
          mainImage.addEventListener("click", openGallery);
        }

        // כפתור "עוד תמונות" - {i18next.t("property.moreImages")}
        const moreImagesButton = document.querySelector(".more-images-fullwidth");
        if (moreImagesButton) {
          moreImagesButton.addEventListener("click", openGallery);
        }

        // כפתורי ניווט במודאל
        const prevButton = document.querySelector(".prev-btn");
        const nextButton = document.querySelector(".next-btn");

        if (prevButton) {
          prevButton.addEventListener("click", function() {
            changeImage(-1);
          });
        }

        if (nextButton) {
          nextButton.addEventListener("click", function() {
            changeImage(1);
          });
        }

        // כפתור סגירת גלריה
        const closeButton = document.querySelector(".close");
        if (closeButton) {
          closeButton.addEventListener("click", closeGallery);
        }
        
        // כפתור סגירת מפה
        const closeMapButton = document.querySelector(".close-map");
        if (closeMapButton) {
          closeMapButton.addEventListener("click", closeMapOverlay);
        }

        // סגירת מודאלים בלחיצה מחוץ לתוכן
        const galleryModal = document.getElementById("galleryModal");
        const mapModal = document.getElementById("mapModal");

        if (galleryModal) {
          galleryModal.addEventListener("click", function(e) {
            if (e.target === galleryModal) {
              closeGallery();
            }
          });
        }

        if (mapModal) {
          mapModal.addEventListener("click", function(e) {
            if (e.target === mapModal) {
              closeMapOverlay();
            }
          });
        }

        // הוספת הפונקציות לגלובל
        window.openGoogleMaps = openGoogleMaps;
        window.openMapOverlay = openMapOverlay;

        // אנימציה לכפתורים הצפים
        const floatingButtons = document.querySelectorAll('.floating-contact-btn');
        floatingButtons.forEach((button, index) => {
          // אנימציה של הופעה
          button.style.opacity = '0';
          button.style.transform = 'translateY(50px)';
          
          setTimeout(() => {
            button.style.transition = 'all 0.5s ease';
            button.style.opacity = '1';
            button.style.transform = 'translateY(0)';
          }, 500 + (index * 200));
          
          // אנימציה של רטט
          button.addEventListener('mouseenter', function() {
            this.style.animation = 'pulse 0.6s ease-in-out';
          });
          
          button.addEventListener('animationend', function() {
            this.style.animation = '';
          });
        });

        // טיפול בטופס יצירת קשר
        const sidebarContactForm = document.getElementById("sidebarContactForm");
        if (sidebarContactForm) {
          sidebarContactForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            
            // הצגת אינדיקטור טעינה
            const submitBtn = sidebarContactForm.querySelector('.submit-btn-sidebar');
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = window.i18next.t("property.sendingData");
            submitBtn.disabled = true;
            
            try {
              const formData = new FormData(sidebarContactForm);
              
              // Debug: הדפסת הנתונים שנשלחים
              console.log("Sending form data:");
              for (const [key, value] of formData) {
                console.log(`${key}: ${value}`);
              }
              
              // שליחה לשרת
              const response = await fetch("/api/contact-request", {
                method: "POST",
                body: formData
              });
              
              const result = await response.json();
              
              if (result.success) {
                // הודעת הצלחה
                alert(result.message || window.i18next.t("common.messages.thankYou"));
                sidebarContactForm.reset();
                
                // אפשרות להפניה לדף תודה או סגירת מודאל
                // window.location.href = "/thank-you";
              } else {
                // הודעת שגיאה
                alert(result.message || window.i18next.t("common.errors.errorSendingRequest"));
              }
              
            } catch (error) {
              console.error("Error sending form:", error);
              alert(window.i18next.t("common.errors.connectionError"));
            } finally {
              // החזרת כפתור למצב רגיל
              submitBtn.textContent = originalBtnText;
              submitBtn.disabled = false;
            }
          });
        }
      });
    </script>
  </body>
</html>