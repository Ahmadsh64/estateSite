---
import { supabase } from "../../lib/supabaseClient";
import i18next from "../../i18n.js";

// ×©×œ×™×¤×ª ×‘×§×©×•×ª ×™×¦×™×¨×ª ×§×©×¨
let contactRequests: any[] = [];

const { data, error } = await supabase
  .from("contact_requests")
  .select("*")
  .order("created_at", { ascending: false });

if (!error && data) {
  contactRequests = data;
} else {
  console.error("Error fetching contact requests:", error);
}
---

<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>× ×™×”×•×œ ×‘×§×©×•×ª ×™×¦×™×¨×ª ×§×©×¨</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="/js/i18n.js" is:inline></script>
  </head>
  <body dir="rtl">
    <header class="admin-header">
      <div class="admin-header-content">
        <h1 class="admin-title">
          <span class="admin-icon">ğŸ“§</span>
          {i18next.t("admin.contactRequests")}
        </h1>
        <nav class="admin-nav">
          <a href="/admin/dashboard" class="admin-nav-btn back-btn">
            <span class="btn-icon">â¬…ï¸</span>
            {i18next.t("admin.backToDashboard")}
          </a>
          <button id="logout-btn" class="admin-nav-btn logout-btn">
            <span class="btn-icon">ğŸšª</span>
            {i18next.t("admin.logout")}
          </button>
        </nav>
      </div>
    </header>

    <main class="admin-main">
      <div class="admin-container">
        <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
        <div class="stats-grid">
          <div class="stat-card">
            <h3>{i18next.t("admin.totalRequests")}</h3>
            <span class="stat-number">{contactRequests.length}</span>
          </div>
          <div class="stat-card">
            <h3>{i18next.t("admin.pendingRequests")}</h3>
            <span class="stat-number">{contactRequests.filter(r => r.status === 'pending').length}</span>
          </div>
          <div class="stat-card">
            <h3>{i18next.t("admin.contactedRequests")}</h3>
            <span class="stat-number">{contactRequests.filter(r => r.status === 'contacted').length}</span>
          </div>
          <div class="stat-card">
            <h3>{i18next.t("admin.closed")}</h3>
            <span class="stat-number">{contactRequests.filter(r => r.status === 'closed').length}</span>
          </div>
        </div>

        <!-- ×¨×©×™××ª ×‘×§×©×•×ª -->
        <div class="contact-requests-list">
          {contactRequests.length > 0 ? (
            contactRequests.map((request) => (
              <div class="contact-request-card" data-id={request.id} data-status={request.status}>
                <div class="request-header">
                  <div class="request-info">
                    <h3 class="request-title">{request.property_title}</h3>
                    <p class="request-client">
                      <strong>{request.full_name}</strong> - {request.email}
                    </p>
                    <p class="request-dates">
                      ğŸ“… {new Date(request.checkin_date).toLocaleDateString('he-IL')} - 
                      {new Date(request.checkout_date).toLocaleDateString('he-IL')}
                    </p>
                    <p class="request-guests">
                      ğŸ‘¥ {request.guests} {i18next.t("admin.guests")}
                    </p>
                  </div>
                  <div class="request-status">
                    <span class={`status-badge status-${request.status}`}>
                      {request.status === 'pending' ? i18next.t("admin.pending") : 
                       request.status === 'contacted' ? i18next.t("admin.contacted") : i18next.t("admin.closed")}
                    </span>
                    <p class="request-date">
                      {new Date(request.created_at).toLocaleDateString('he-IL')} 
                      {new Date(request.created_at).toLocaleTimeString('he-IL')}
                    </p>
                  </div>
                </div>

                <div class="request-details">
                  <div class="detail-row">
                    <strong>{i18next.t("admin.phone")}:</strong>
                    <a href={`tel:${request.phone}`} class="contact-link">ğŸ“ {request.phone}</a>
                  </div>
                  {request.special_requests && (
                    <div class="detail-row">
                      <strong>{i18next.t("admin.specialRequests")}:</strong>
                      <p class="special-requests">{request.special_requests}</p>
                    </div>
                  )}
                  <div class="detail-row">
                    <strong>{i18next.t("admin.propertyPrice")}:</strong>
                    <span>{request.property_price.toLocaleString('he-IL')} â‚ª</span>
                  </div>
                </div>

                <div class="request-actions">
                  <a href={`tel:${request.phone}`} class="action-btn call-btn">
                    ğŸ“ {i18next.t("admin.call")}
                  </a>
                  <a href={`mailto:${request.email}?subject=×‘×§×©×” ×œ×“×™×¨×”: ${request.property_title}`} class="action-btn email-btn">
                    ğŸ“§ {i18next.t("admin.sendEmail")}
                  </a>
                  <a href={`https://wa.me/972${request.phone.replace(/^0/, '')}?text=×©×œ×•× ${request.full_name}, ×× ×™ ××ª×§×©×¨ ×‘× ×•×’×¢ ×œ×‘×§×©×” ×œ×“×™×¨×”: ${request.property_title}`} 
                     target="_blank" class="action-btn whatsapp-btn">
                    ğŸ’¬ WhatsApp
                  </a>
                  
                  {request.status === 'pending' && (
                    <button class="action-btn mark-contacted-btn" data-id={request.id}>
                      âœ… {i18next.t("admin.markAsContacted")}
                    </button>
                  )}
                  
                  {request.status === 'contacted' && (
                    <button class="action-btn mark-closed-btn" data-id={request.id}>
                      ğŸ”’ {i18next.t("admin.closeRequest")}
                    </button>
                  )}
                  
                  <button class="action-btn delete-btn" data-id={request.id}>
                    ğŸ—‘ï¸ {i18next.t("admin.delete")}
                  </button>
                </div>
              </div>
            ))
          ) : (
            <div class="no-requests">
              <p>{i18next.t("admin.noContactRequests")}</p>
            </div>
          )}
        </div>
      </div>
    </main>

    <script type="module">
      // ×‘×“×™×§×ª ×”×¨×©××•×ª ×× ×”×œ
      const session = JSON.parse(sessionStorage.getItem("sb-session") || "{}");
      if (!session.access_token) {
        alert(window.i18next.t("admin.noPermission"));
        window.location.href = "/admin/login";
      }

      // ×›×¤×ª×•×¨ ×™×¦×™××”
      document.getElementById("logout-btn").addEventListener("click", () => {
        sessionStorage.removeItem("sb-session");
        window.location.href = "/admin/login";
      });

      // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×‘×§×©×”
      async function updateRequestStatus(requestId, newStatus) {
        try {
          console.log(`Updating request ${requestId} to status ${newStatus}`);
          
          if (!session.access_token) {
            alert(window.i18next.t("admin.noPermission"));
            window.location.href = "/admin/login";
            return;
          }
          
          const response = await fetch("/api/contact-request", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${session.access_token}`
            },
            body: JSON.stringify({
              id: requestId,
              status: newStatus
            })
          });

          console.log(`Response status: ${response.status}`);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`HTTP error: ${response.status} - ${errorText}`);
            throw new Error(`HTTP error: ${response.status}`);
          }

          const result = await response.json();
          console.log("Update result:", result);
          
          if (result.success) {
            // ×¢×“×›×•×Ÿ UI
            const requestCard = document.querySelector(`[data-id="${requestId}"]`);
            if (requestCard) {
              requestCard.dataset.status = newStatus;
              const statusBadge = requestCard.querySelector('.status-badge');
              if (statusBadge) {
                statusBadge.className = `status-badge status-${newStatus}`;
                statusBadge.textContent = newStatus === 'pending' ? window.i18next.t("admin.pending") : 
                                         newStatus === 'contacted' ? window.i18next.t("admin.contacted") : window.i18next.t("admin.closed");
              }
              
              // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™×
              const markBtn = requestCard.querySelector('.mark-contacted-btn, .mark-closed-btn');
              if (markBtn) {
                if (newStatus === 'contacted') {
                  markBtn.textContent = 'ğŸ”’ ' + window.i18next.t("admin.closeRequest");
                  markBtn.className = 'action-btn mark-closed-btn';
                } else if (newStatus === 'closed') {
                  markBtn.remove();
                }
              }
            }
            
            alert(window.i18next.t("admin.statusUpdated"));
          } else {
            console.error("Update failed:", result.message);
            alert(window.i18next.t("admin.errorUpdatingStatus") + " " + result.message);
          }
        } catch (error) {
          console.error("Error updating status:", error);
          alert(window.i18next.t("admin.errorUpdatingStatus") + " " + error.message);
        }
      }

      // ×¤×•× ×§×¦×™×” ×œ××—×™×§×ª ×‘×§×©×”
      async function deleteRequest(requestId) {
        if (!confirm(window.i18next.t("admin.confirmDelete"))) {
          return;
        }

        try {
          console.log(`Deleting request ${requestId}`);
          
          if (!session.access_token) {
            alert(window.i18next.t("admin.noPermission"));
            window.location.href = "/admin/login";
            return;
          }
          
          const response = await fetch("/api/contact-request", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${session.access_token}`
            },
            body: JSON.stringify({ id: requestId })
          });

          console.log(`Response status: ${response.status}`);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`HTTP error: ${response.status} - ${errorText}`);
            throw new Error(`HTTP error: ${response.status}`);
          }

          const result = await response.json();
          console.log("Delete result:", result);
          
          if (result.success) {
            // ×”×¡×¨×ª ×”×§×œ×£ ××”×××©×§
            const requestCard = document.querySelector(`[data-id="${requestId}"]`);
            if (requestCard) {
              requestCard.remove();
            }
            alert(window.i18next.t("admin.requestDeleted"));
          } else {
            console.error("Delete failed:", result.message);
            alert(window.i18next.t("admin.errorDeletingRequest") + " " + result.message);
          }
        } catch (error) {
          console.error("Error deleting request:", error);
          alert(window.i18next.t("admin.errorDeletingRequest") + " " + error.message);
        }
      }

      // ×—×™×‘×•×¨ ××™×¨×•×¢×™× ×œ×›×¤×ª×•×¨×™×
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("mark-contacted-btn")) {
          updateRequestStatus(e.target.dataset.id, "contacted");
        } else if (e.target.classList.contains("mark-closed-btn")) {
          updateRequestStatus(e.target.dataset.id, "closed");
        } else if (e.target.classList.contains("delete-btn")) {
          deleteRequest(e.target.dataset.id);
        }
      });
    </script>

  </body>
</html>
