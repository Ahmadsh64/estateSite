---
import i18next from '../../i18n.js';
---
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>â• {i18next.t("admin.addNewProperty")}</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body dir="rtl">
    <header class="admin-add-header">
      <h1>â• {i18next.t("admin.addNewProperty")}</h1>
      <nav class="admin-nav">
        <a href="/admin/dashboard" class="admin-add-back">â¬…ï¸ {i18next.t("admin.backToDashboard")}</a>
        <button id="logout-btn" class="admin-logout-btn">ğŸšª {i18next.t("admin.logout")}</button>
      </nav>
    </header>

    <main class="admin-add-main">
      <form id="admin-add-form" class="admin-add-form">
        <!-- ×›×•×ª×¨×ª ×•××—×™×¨ -->
        <label>{i18next.t("admin.title")}</label>
        <input type="text" name="title" required />

        <label>{i18next.t("admin.pricePerNight")}</label>
        <input type="number" name="price" required />

        <!-- ××™×§×•× -->
        <fieldset>
          <legend>ğŸ“ {i18next.t("admin.location")}</legend>
          <label>{i18next.t("admin.city")}</label>
          <input type="text" name="city" required />
          <label>{i18next.t("admin.street")}</label>
          <input type="text" name="street" />
          <label>{i18next.t("admin.number")}</label>
          <input type="text" name="number" />
          <label>{i18next.t("admin.floor")}</label>
          <input type="text" name="floor" />
        </fieldset>

        <!-- ×ª×™××•×¨ ×•×ª××•× ×•×ª -->
        <label>{i18next.t("admin.description")}</label>
        <textarea name="description" required></textarea>

        <label>{i18next.t("admin.images")}</label>
        <input type="file" name="images" accept="image/*" multiple />

        <!-- ×¤×¨×˜×™× × ×•×¡×¤×™× -->
        <fieldset>
          <legend>ğŸ› {i18next.t("admin.propertyDetails")}</legend>
          <label>{i18next.t("admin.bedrooms")}</label>
          <input type="number" name="bedrooms" />
          <label>{i18next.t("admin.beds")}</label>
          <input type="number" name="beds" />
          <label>{i18next.t("admin.bathrooms")}</label>
          <input type="number" name="bathrooms" />
          <label>{i18next.t("admin.maxOccupancy")}</label>
          <input type="number" name="occupancy" />
          <label>{i18next.t("admin.propertyType")}</label>
          <input type="text" name="type" />
        </fieldset>

        <!-- ××ª×§× ×™× -->
        <fieldset>
          <legend>âš™ï¸ {i18next.t("admin.amenities")}</legend>
          <label><input type="checkbox" name="kitchen" /> {i18next.t("admin.kitchen")}</label>
          <label><input type="checkbox" name="washingmachine" /> {i18next.t("admin.washingmachine")}</label>
          <label><input type="checkbox" name="wifi" /> {i18next.t("admin.wifi")}</label>
          <label><input type="checkbox" name="tv" /> {i18next.t("admin.tv")}</label>
          <label><input type="checkbox" name="publictransportnearby" /> {i18next.t("admin.publictransportnearby")}</label>
          <label><input type="checkbox" name="parking" /> {i18next.t("admin.parking")}</label>
          <label><input type="checkbox" name="has_pool" /> {i18next.t("admin.pool")}</label>
          <label><input type="checkbox" name="has_private_pool" /> {i18next.t("admin.privatePool")}</label>
          <label><input type="checkbox" name="has_jacuzzi" /> {i18next.t("admin.jacuzzi")}</label>
          <label><input type="checkbox" name="has_grill" /> {i18next.t("admin.grill")}</label>
        </fieldset>

        <!-- ×¤×¨×˜×™ ×™×¦×™×¨×ª ×§×©×¨ -->
        <fieldset>
          <legend>ğŸ“ {i18next.t("admin.contactInfo")}</legend>
          <label>{i18next.t("admin.phone")}</label>
          <input type="text" name="phone" />
          <label>{i18next.t("admin.whatsapp")}</label>
          <input type="text" name="whatsapp" />
        </fieldset>

        <!-- ×ª× ××™× -->
        <fieldset>
          <legend>â° {i18next.t("admin.terms")}</legend>
          <label>{i18next.t("admin.checkInTime")}</label>
          <input type="time" name="checkInTime" />
          <label>{i18next.t("admin.checkOutTime")}</label>
          <input type="time" name="checkOutTime" />
          <label>{i18next.t("admin.minstaydays")}</label>
          <input type="number" name="minstaydays" />
        </fieldset>

        <!-- ×§×˜×’×•×¨×™×•×ª -->
        <fieldset>
          <legend>ğŸ¯ {i18next.t("admin.suitableFor")}</legend>
          <label><input type="checkbox" name="suitable_for" value="××©×¤×—×•×ª" /> {i18next.t("admin.families")}</label>
          <label><input type="checkbox" name="suitable_for" value="×“×ª×™×™×" /> {i18next.t("admin.religious")}</label>
          <label><input type="checkbox" name="suitable_for" value="×§×‘×•×¦×•×ª" /> {i18next.t("admin.groups")}</label>
          <label><input type="checkbox" name="suitable_for" value="×–×•×’×•×ª" /> {i18next.t("admin.couples")}</label>
        </fieldset>

        <fieldset>
          <legend>ğŸ“ {i18next.t("admin.nearby")}</legend>
          <label><input type="checkbox" name="nearby" value="×‘×™×ª ×›× ×¡×ª" /> {i18next.t("admin.synagogue")}</label>
          <label><input type="checkbox" name="nearby" value="××¡×¢×“×•×ª" /> {i18next.t("admin.restaurants")}</label>
          <label><input type="checkbox" name="nearby" value="××¨×›×– ×§× ×™×•×ª" /> {i18next.t("admin.shoppingCenter")}</label>
          <label><input type="checkbox" name="nearby" value="×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª" /> {i18next.t("admin.publicTransport")}</label>
        </fieldset>

        <button type="submit">ğŸ’¾ {i18next.t("admin.save")}</button>
      </form>

      <p id="admin-add-message"></p>
    </main>


    <script type="module">
      const form = document.getElementById("admin-add-form");
      const msg = document.getElementById("admin-add-message");
      const logoutBtn = document.getElementById("logout-btn");

      // ×›×¤×ª×•×¨ ×™×¦×™××”
      logoutBtn.addEventListener("click", () => {
        sessionStorage.removeItem("sb-session");
        window.location.href = "/admin/login";
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);

        // ××™×¡×•×£ ×›×œ ×”-checkboxes ××¡×•×’ suitableFor ×•-nearby ×›××¢×¨×›×™×
        const suitableFor = Array.from(
          form.querySelectorAll('input[name="suitable_for"]:checked'),
        ).map((cb) => cb.value);
        const nearby = Array.from(
          form.querySelectorAll('input[name="nearby"]:checked'),
        ).map((cb) => cb.value);

        formData.append("suitable_for", JSON.stringify(suitableFor));
        formData.append("nearby", JSON.stringify(nearby));

        // ×‘×“×™×§×ª MIME type ×©×œ ×”×ª××•× ×•×ª
        const allowedMimeTypes = [
          "image/jpeg",
          "image/png",
          "image/gif",
          "image/webp",
        ];
        const files = form.querySelector('input[type="file"]').files;

        for (const file of files) {
          if (!allowedMimeTypes.includes(file.type)) {
            msg.textContent = `âŒ ×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š ×¢×‘×•×¨ ${file.name}. ×¨×§ ×ª××•× ×•×ª × ×ª××›×•×ª.`;
            msg.style.color = "red";
            return;
          }
        }

        // ×§×‘×œ×ª ×”×˜×•×§×Ÿ ××”-sessionStorage
        const session = sessionStorage.getItem("sb-session");
        if (!session) {
          msg.textContent = "âŒ ××™×Ÿ ×”×¨×©××” â€“ ×× × ×”×ª×—×‘×¨ ××—×“×©";
          msg.style.color = "red";
          setTimeout(() => {
            window.location.href = "/admin/login";
          }, 3000);
          return;
        }

        const token = JSON.parse(session).access_token;

        try {
          const res = await fetch("/api/add-property", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          const result = await res.json();

          if (result.success) {
            msg.textContent = "âœ… ×”×“×™×¨×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!";
            msg.style.color = "green";
            form.reset();
          } else {
            msg.textContent = `âŒ ×©×’×™××”: ${result.message}`;
            msg.style.color = "red";
            if (res.status === 403) {
              setTimeout(() => {
                window.location.href = "/admin/login";
              }, 9000);
            }
          }
        } catch (err) {
          console.error(err);
          msg.textContent = "âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª";
          msg.style.color = "red";
        }
      });
    </script>
  </body>
</html>
