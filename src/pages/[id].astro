---
import i18next from "../i18n";
import { supabase } from "../lib/supabaseClient";
import type { Property } from "../types/property";  // ייבוא טיפוס Property

const { params } = Astro;
const id = params.id;

let property: Property | null = null; // הגדרת property כ-Property או null

// שליפת הדירה לפי ID מ-Supabase
const { data, error } = await supabase
  .from("properties")
  .select("*")
  .eq("id", id)
  .single();

if (error) {
  console.error("שגיאה בשליפת הדירה:", error.message);
} 
if (data) {
  // המרת הנתונים לטיפוס Property
  property = {
    id: data.id,
    title: data.title,
    price: data.price,
    location: {
      city: data.city || "",
      street: data.street || "",
      number: data.number || "",
      floor: data.floor || "",
    },
    description: data.description || "",
    images: data.images || [],
    occupancy: data.occupancy,
    bedrooms: data.bedrooms,
    beds: data.beds,
    bathrooms: data.bathrooms,
    kitchen: data.kitchen, 
    washingmachine: data.washingmachine,
    wifi: data.wifi,
    tv: data.tv,
    publictransportnearby: data.publictransportnearby,
    parking: data.parking,
    checkintime: data.checkintime,
    checkouttime: data.checkouttime,
    minStayDays: data.minStayDays,
    type: data.type,
    is_active: data.is_active, // הוספת השדה החסר
    created_at: data.created_at,
    has_pool: data.has_pool,            // בריכה
    has_private_pool: data.has_private_pool,    // בריכה פרטית
    has_jacuzzi: data.has_jacuzzi,          // ג'קוזי
    has_grill: data.has_grill,            // מנגל
    suitable_for: data.suitable_for,        // מתאים ל: משפחות, דתיים, קבוצות
    nearby: data.nearby,            // בקרבת המקום: בית כנסת, מסעדות, תחבורה ציבורית
    rating: data.rating,               // דירוג
    reviews_count: data.reviews_count,        // מספר חוות דעת
    phone: data.phone,                // מספר טלפון
    whatsapp: data.whatsapp,             // מספר WhatsApp
  };
}

const images = property ? (Array.isArray(property.images) ? property.images : [property.images]) : [];
---

<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>{property ? property.title : i18next.t("property.notFound")}</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body dir="rtl">
    <header class="detail-header">
      <a href="/" class="detail-back-btn">⬅ {i18next.t("property.backToList")}</a>
    </header>

    <main class="detail-container">
      {property ? (
        <>
          <div class="detail-header-bar">
            <div class="detail-header-right">
              <h1>{property.title}</h1>
              <p class="detail-location">{property.location.city}, {property.location.street}, {property.location.number} - {i18next.t("property.floor")} {property.location.floor}</p>
              <p class="detail-rating">
                ⭐ {property.rating || i18next.t("property.noRating")} {i18next.t("property.excellent")} ({property.reviews_count || 0} {i18next.t("property.reviews")})
              </p>
              <p class="detail-summary">
                {i18next.t("property.bedrooms")}: {property.bedrooms} | {i18next.t("property.bathrooms")}: {property.bathrooms} | {i18next.t("property.maxGuests")}: {property.occupancy}
              </p>
            </div>
            <div class="detail-header-left">
              <button class="contact-btn" onclick="window.location.href='tel:{property.phone}'">📞 {property.phone}</button>
              <button class="contact-btn" onclick="window.location.href='https://wa.me/{property.whatsapp}'">{i18next.t("property.whatsapp")}</button>
            </div>
          </div>

          <div class="detail-gallery-map">
            <div class="detail-gallery">
              <img id="detailMainImage" src={property.images[0]} alt={property.title} class="detail-main-image" />
              <div class="detail-thumbs">
                {property.images && Array.isArray(property.images) ? (
                  property.images.map((img, i) => (
                    <img
                      src={img}
                      alt={`תמונה ${i+1} של ${property.title}`}
                      class="detail-thumb"
                      id={`thumb-${i}`}
                    />
                  ))
                ) : (
                  <p>{i18next.t("property.noImages")}</p>
                )}
              </div>
            </div>
            <div class="map-box">
              <div class="map-item">
                <img src="/images/map.png" alt={i18next.t("property.map")} title={i18next.t("property.map")} />
                <button class="map-btn-expand" onclick="window.open('https://www.google.com/maps?q={property.location.city}+{property.location.street}', '_blank')">
                  {i18next.t("property.openMap")}
                </button>
              </div>
            </div>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.details")}</h3>
            <p class="detail-description">{property.description}</p>
            <ul class="detail-info-list">
              <li><strong>{i18next.t("property.pricePerNight")}:</strong> {property.price} ₪</li>
              <li><strong>{i18next.t("property.propertyType")}:</strong> {property.type}</li>
              <li><strong>{i18next.t("property.location")}:</strong> {property.location.city}, {property.location.street} {property.location.number}, {i18next.t("property.floor")} {property.location.floor}</li>
              <li><strong>{i18next.t("property.maxGuests")}:</strong> {property.occupancy}</li>
              <li><strong>{i18next.t("property.bedrooms")}:</strong> {property.bedrooms}</li>
              <li><strong>{i18next.t("property.beds")}:</strong> {property.beds}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.features")}</h3>
            <h4>{i18next.t("property.general")}</h4>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.maxGuests")}:</strong> {property.occupancy}</li>
              <li><strong>{i18next.t("property.bedrooms")}:</strong> {property.bedrooms}</li>
              <li><strong>{i18next.t("property.beds")}:</strong> {property.beds}</li>
              <li><strong>{i18next.t("property.bathrooms")}:</strong> {property.bathrooms}</li>
              <li><strong>{i18next.t("property.kitchen")}:</strong> {property.kitchen ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.washingmachine")}:</strong> {property.washingmachine ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.wifi")}:</strong> {property.wifi ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.tv")}:</strong> {property.tv ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.publictransportnearby")}</strong> {property.publictransportnearby ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.parking")}:</strong> {property.parking ? "✔️" : "❌"}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.outdoorFacilities")}</h3>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.privatePool")}:</strong> {property.has_private_pool ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.sharedPool")}:</strong> {property.has_pool ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.jacuzzi")}:</strong> {property.has_jacuzzi ? "✔️" : "❌"}</li>
              <li><strong>{i18next.t("property.grill")}:</strong> {property.has_grill ? "✔️" : "❌"}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h4>{i18next.t("property.suitableFor")}</h4>
            <ul class="feature-list">
              {Array.isArray(property.suitable_for) && property.suitable_for.map((group, i) => (
                <li>{group}</li>
              ))}
            </ul>
          </div>

          <div class="detail-info-box">
            <h4>{i18next.t("property.nearby")}</h4>
            <ul class="feature-list">
              {Array.isArray(property.nearby) && property.nearby.map((group, i) => (
                <li>{group}</li>
              ))}
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.contactInfo")}</h3>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.phone")}:</strong> {property.phone || i18next.t("property.notAvailable")}</li>
              <li><strong>{i18next.t("property.whatsapp")}:</strong> {property.whatsapp || i18next.t("property.notAvailable")}</li>
            </ul>
          </div>

          <div class="detail-info-box">
            <h3>{i18next.t("property.terms")}</h3>
            <ul class="feature-list">
              <li><strong>{i18next.t("property.checkintime")}:</strong> {property.checkintime || i18next.t("property.notSpecified")}</li>
              <li><strong>{i18next.t("property.checkouttime")}:</strong> {property.checkouttime || i18next.t("property.notSpecified")}</li>
              <li><strong>{i18next.t("property.minstaydays")}:</strong> {property.minStayDays || 0}</li>
            </ul>
          </div>

          <!-- טופס יצירת קשר -->
<div class="contact-form">
            <h3>אני רוצה להתארח כאן</h3>
            <form action="#" method="POST">
              <label for="full-name">שם מלא</label>
              <input type="text" id="full-name" name="full-name" placeholder="הכנס את שמך המלא" required>

              <label for="email">כתובת דואר אלקטרוני</label>
              <input type="email" id="email" name="email" placeholder="הכנס את כתובת הדואר האלקטרוני שלך" required>

              <label for="phone">מספר טלפון</label>
              <input type="tel" id="phone" name="phone" placeholder="הכנס את מספר הטלפון שלך" required>

              <label for="guests">בחירת הרכב</label>
              <select id="guests" name="guests">
                <option value="2">2 נופשים</option>
                <option value="3">3 נופשים</option>
                <option value="4">4 נופשים</option>
                <option value="5">5 נופשים</option>
              </select>

              <label for="checkin">צ'ק-אין</label>
              <input type="date" id="checkin" name="checkin" required>

              <label for="checkout">צ'ק-אאוט</label>
              <input type="date" id="checkout" name="checkout" required>

              <label for="special-requests">בקשות מיוחדות</label>
              <textarea id="special-requests" name="special-requests" placeholder="מוזמנים להוסיף בקשה למקום האירוח"></textarea>

              <label for="offers">מעוניין לקבל מבצעים בדואר אלקטרוני</label>
              <input type="checkbox" id="offers" name="offers">

              <button type="submit" class="submit-btn">חזרו אלי</button>
            </form>
          </div>
        </>
      ) : (
        <p class="detail-not-found">{i18next.t("property.notFound")}</p>
      )}
    </main>
 <script type="module">
  document.addEventListener("DOMContentLoaded", function () {
    // פונקציה להחלפת תמונה ראשית בלחיצה על תמונה קטנה
    function changeImage(event) {
      const newImageSrc = event.target.src;
      const mainImage = document.getElementById("detailMainImage");
      if (mainImage) { // וודא שהאלמנט קיים
        mainImage.src = newImageSrc;
      }
    }

    // פונקציה להצגת התמונה בגודל מלא בלחיצה על התמונה הראשית
    function openFullScreen() {
      const mainImage = document.getElementById("detailMainImage");
      const fullScreenModal = document.getElementById("fullScreenModal");
      const fullScreenImage = document.getElementById("fullScreenImage");

      if (mainImage && fullScreenModal && fullScreenImage) { // בדוק אם כל האלמנטים קיימים
        fullScreenImage.src = mainImage.src;
        fullScreenModal.style.display = "flex";
      }
    }

    // סגור את חלון התמונה הגדולה בלחיצה על ה-X
    function closeFullScreen() {
      const fullScreenModal = document.getElementById("fullScreenModal");
      if (fullScreenModal) { // בדוק אם המודאל קיים
        fullScreenModal.style.display = "none";
      }
    }

    // מאזינים לאירועים לתמונות מיני
    const thumbs = document.querySelectorAll(".detail-thumb");
    if (thumbs.length > 0) { // בדוק אם יש תמונות מיני
      thumbs.forEach(thumb => {
        thumb.addEventListener("click", changeImage);
      });
    }

    // מאזין לאירועים לתמונה הראשית
    const mainImage = document.getElementById("detailMainImage");
    if (mainImage) { // אם התמונה הראשית קיימת
      mainImage.addEventListener("click", openFullScreen);
    }

    // הוספת מאזין לכפתור סגירה של המודאל
    const modalClose = document.getElementById("modalClose");
    if (modalClose) { // אם כפתור הסגירה קיים
      modalClose.addEventListener("click", closeFullScreen);
    }

    // הוספת מאזינים לכפתורים של יצירת קשר
    const phoneButton = document.getElementById("phoneButton");
    if (phoneButton) { // אם כפתור הטלפון קיים
      phoneButton.addEventListener("click", function () {
        window.location.href = `tel:${property.phone}`;
      });
    }

    const whatsappButton = document.getElementById("whatsappButton");
    if (whatsappButton) { // אם כפתור ה-WhatsApp קיים
      whatsappButton.addEventListener("click", function () {
        window.location.href = `https://wa.me/${property.whatsapp}`;
      });
    }
  });
</script>

  </body>
</html>

