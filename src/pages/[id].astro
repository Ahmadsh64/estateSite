---
import { supabase } from "../lib/supabaseClient";
import type { Property } from "../types/property";  // ×™×™×‘×•× ×˜×™×¤×•×¡ Property

const { params } = Astro;
const id = params.id;

let property: Property | null = null; // ×”×’×“×¨×ª property ×›-Property ××• null

// ×©×œ×™×¤×ª ×”×“×™×¨×” ×œ×¤×™ ID ×-Supabase
const { data, error } = await supabase
  .from("properties")
  .select("*")
  .eq("id", id)
  .single();

if (error) {
  console.error("×©×’×™××” ×‘×©×œ×™×¤×ª ×”×“×™×¨×”:", error.message);
} 
if (data) {
  // ×”××¨×ª ×”× ×ª×•× ×™× ×œ×˜×™×¤×•×¡ Property
  property = {
    id: data.id,
    title: data.title,
    price: data.price,
    location: {
      city: data.city || "",
      street: data.street || "",
      number: data.number || "",
      floor: data.floor || "",
    },
    description: data.description || "",
    images: data.images || [],
    occupancy: data.occupancy,
    bedrooms: data.bedrooms,
    beds: data.beds,
    bathrooms: data.bathrooms,
    hasKitchen: data.kitchen, 
    washingmachine: data.washingmachine,
    hasWifi: data.wifi,
    hasTv: data.tv,
    publicTransportNearby: data.publicTransportNearby,
    parking: data.parking,
    checkInTime: data.checkInTime,
    checkOutTime: data.checkOutTime,
    minStayDays: data.minStayDays,
    type: data.type,
    is_active: data.is_active, // ×”×•×¡×¤×ª ×”×©×“×” ×”×—×¡×¨
    created_at: data.created_at, // ×”×•×¡×¤×ª ×”×©×“×” ×”×—×¡×¨
  };
}

const images = property ? (Array.isArray(property.images) ? property.images : [property.images]) : [];
---

<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>{property ? property.title : "×“×™×¨×” ×œ× × ××¦××”"}</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body dir="rtl">
    <header class="detail-header">
      <a href="/" class="detail-back-btn">â¬… ×—×–×¨×” ×œ×¨×©×™××ª ×“×™×¨×•×ª</a>
    </header>

    <main class="detail-container">
      {property ? (
        <>
          <div class="detail-gallery">
            <img id="detailMainImage" src={images[0] } alt={property.title} class="detail-main-image" />
            <div class="detail-thumbs">
              {images.map((img, i) => (
                <img 
                  src={img} 
                  alt={`×ª××•× ×” ${i+1} ×©×œ ${property.title}`} 
                  class="detail-thumb" 
                  id={`thumb-${i}`} 
                />
              ))}
            </div>
          </div>

          <div class="detail-info">
            <h1 class="detail-title">{property.title}</h1>
            <p class="detail-price">××—×™×¨: {property.price.toLocaleString("he-IL")}</p>

            <h3>××™×§×•×:</h3>
            <p class="detail-location">
              {property.location.city}, {property.location.street} {property.location.number}
              {property.location.floor ? `, ×§×•××” ${property.location.floor}` : ""}
            </p>

            <p class="detail-description">{property.description}</p>

            <ul class="detail-info-list">
              <li>ğŸ› ××¡×¤×¨ ×—×“×¨×™×: {property.bedrooms}</li>
              <li>ğŸ›Œ ××™×˜×•×ª: {property.beds}</li>
              <li>ğŸš¿ ×—×“×¨×™ ×××‘×˜×™×”: {property.bathrooms}</li>
              <li>ğŸ  ×¡×•×’ × ×›×¡: {property.type}</li>
              <li>ğŸ³ ××˜×‘×—: {property.hasKitchen ? "×›×Ÿ" : "×œ×"}</li>
              <li>ğŸ§º ××›×•× ×ª ×›×‘×™×¡×”: {property.washingmachine ? "×›×Ÿ" : "×œ×"}</li>
              <li>ğŸ“¶ Wi-Fi: {property.hasWifi ? "×›×Ÿ" : "×œ×"}</li>
              <li>ğŸ“º ×˜×œ×•×•×™×–×™×”: {property.hasTv ? "×›×Ÿ" : "×œ×"}</li>
              <li>ğŸšŒ ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×‘×¡×‘×™×‘×”: {property.publicTransportNearby ? "×›×Ÿ" : "×œ×"}</li>
              <li>ğŸš— ×—× ×™×”: {property.parking ? "×›×Ÿ" : "×œ×"}</li>
              <li>â° ×©×¢×ª ×›× ×™×¡×”: {property.checkInTime || "×œ× ×¦×•×™× ×”"}</li>
              <li>â° ×©×¢×ª ×™×¦×™××”: {property.checkOutTime || "×œ× ×¦×•×™× ×”"}</li>
              <li>ğŸ—“ ××™× ×™××•× ×”×–×× ×” ×‘×™××™×: {property.minStayDays || "×œ× ×¦×•×™× ×”"}</li>
            </ul>
          </div>
        </>
      ) : (
        <p class="detail-not-found">×“×™×¨×” ×–×• ×œ× ×§×™×™××ª.</p>
      )}
    </main>

    <script>
      // ×”×¤×•× ×§×¦×™×” ×©×ª×—×œ×™×£ ××ª ×”×ª××•× ×” ×”×¨××©×™×ª ×›××©×¨ × ×œ×—×¥ ×¢×œ ×ª××•× ×” ×‘×ª×¦×•×’×” ×”×§×˜× ×”
      document.querySelectorAll('.detail-thumb').forEach((thumb) => {
        thumb.addEventListener('click', (event) => {
          const mainImage = document.getElementById('detailMainImage') as HTMLImageElement; // ×˜×™×¤×•×¡ ×¡×¤×¦×™×¤×™
          const target = event.target as HTMLImageElement; // ×˜×™×¤×•×¡ ×¡×¤×¦×™×¤×™
          if (mainImage && target) {
            mainImage.src = target.src;
          }
        });
      });
    </script>
  </body>
</html>
