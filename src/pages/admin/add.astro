---
import { supabase } from "../../lib/supabaseClient";
---

<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>הוספת דירה חדשה</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body dir="rtl">
  <header class="admin-add-header">
    <h1>➕ הוספת דירה חדשה</h1>
    <a href="/admin/dashboard" class="admin-add-back">⬅️ חזרה לדשבורד</a>
  </header>

  <main class="admin-add-main">
    <form id="admin-add-form" class="admin-add-form">
      <label class="admin-add-label">כותרת:</label>
      <input type="text" name="title" class="admin-add-input" required />

      <label class="admin-add-label">מחיר:</label>
      <input type="text" name="price" class="admin-add-input" required />

      <label class="admin-add-label">מיקום:</label>
      <input type="text" name="location" class="admin-add-input" required />

      <label class="admin-add-label">תיאור:</label>
      <textarea name="description" class="admin-add-textarea" required></textarea>

      <label class="admin-add-label">תמונות:</label>
      <div class="admin-add-image-upload-wrapper">
        <input type="file" id="admin-add-image-input" name="images" accept="image/*" multiple />
        <button type="button" id="admin-add-addMoreBtn" class="admin-add-add-btn">+</button>
      </div>
      <div id="admin-add-preview" class="admin-add-image-preview"></div>

      <button type="submit" class="admin-add-submit-btn">שמור</button>
    </form>

    <p id="admin-add-message" class="admin-add-message"></p>

    <script type="module">
      const form = document.getElementById("admin-add-form");
      const msg = document.getElementById("admin-add-message");
      const imageInput = document.getElementById("admin-add-image-input");
      const addMoreBtn = document.getElementById("admin-add-addMoreBtn");
      const preview = document.getElementById("admin-add-preview");

      let allFiles = [];

      function updatePreview() {
        preview.innerHTML = "";
        allFiles.forEach((file, idx) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.classList.add("admin-add-preview-img");
            img.title = "לחץ למחיקה";
            img.addEventListener("click", () => {
              allFiles.splice(idx, 1);
              updatePreview();
            });
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      }

      imageInput.addEventListener("change", (e) => {
        allFiles = allFiles.concat(Array.from(e.target.files));
        updatePreview();
        imageInput.value = "";
      });

      addMoreBtn.addEventListener("click", () => {
        imageInput.click();
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        allFiles.forEach((file) => formData.append("images", file));

        try {
          const res = await fetch("/api/add-property", {
            method: "POST",
            body: formData
          });

          const result = await res.json();
          if (result.success) {
            msg.textContent = "✅ הדירה נוספה בהצלחה!";
            msg.style.color = "green";
            form.reset();
            allFiles = [];
            updatePreview();
          } else {
            msg.textContent = `❌ שגיאה: ${result.message}`;
            msg.style.color = "red";
          }
        } catch (err) {
          console.error(err);
          msg.textContent = "❌ שגיאה בחיבור לשרת";
          msg.style.color = "red";
        }
      });
    </script>
  </main>
</body>
</html>
