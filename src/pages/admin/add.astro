---
import { supabase } from "../../lib/supabaseClient";
import type { Property } from "../../types/property";
---

<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>➕ הוספת דירה חדשה</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body dir="rtl">
<header class="admin-add-header">
  <h1>➕ הוספת דירה חדשה</h1>
  <nav class="admin-nav">
    <a href="/admin/dashboard" class="admin-add-back">⬅️ חזרה לדשבורד</a>
    <button id="logout-btn" class="admin-logout-btn">🚪 יציאה</button>
  </nav>
</header>

<main class="admin-add-main">
  <form id="admin-add-form" class="admin-add-form">
    <!-- כותרת ומחיר -->
    <label>כותרת:</label>
    <input type="text" name="title" required />

    <label>מחיר:</label>
    <input type="number" name="price" required />

    <!-- מיקום -->
    <label>עיר:</label>
    <input type="text" name="city" required />
    <label>רחוב:</label>
    <input type="text" name="street" />
    <label>מספר:</label>
    <input type="text" name="number" />
    <label>קומה:</label>
    <input type="text" name="floor" />

    <!-- תיאור ותמונות -->
    <label>תיאור:</label>
    <textarea name="description" required></textarea>

    <label>תמונות:</label>
    <input type="file" name="images" accept="image/*" multiple />

    <!-- פרטים נוספים -->
    <label>מספר חדרים:</label>
    <input type="number" name="bedrooms" />
    <label>מספר מיטות:</label>
    <input type="number" name="beds" />
    <label>מספר חדרי אמבטיה:</label>
    <input type="number" name="bathrooms" />

    <label>סוג נכס:</label>
    <input type="text" name="type" />

    <label>מטבח:</label>
    <input type="checkbox" name="kitchen" />
    <label>מכונת כביסה:</label>
    <input type="checkbox" name="washingMachine" />
    <label>Wi-Fi:</label>
    <input type="checkbox" name="wifi" />
    <label>טלוויזיה:</label>
    <input type="checkbox" name="tv" />
    <label>תחבורה ציבורית בסביבה:</label>
    <input type="checkbox" name="publicTransportNearby" />
    <label>חניה:</label>
    <input type="checkbox" name="parking" />

    <label>שעת כניסה:</label>
    <input type="time" name="checkInTime" />
    <label>שעת יציאה:</label>
    <input type="time" name="checkOutTime" />
    <label>מינימום ימים:</label>
    <input type="number" name="minStayDays" />

    <button type="submit">שמור</button>
  </form>

  <p id="admin-add-message"></p>
</main>

<script type="module">
  const form = document.getElementById("admin-add-form");
  const msg = document.getElementById("admin-add-message");
  const logoutBtn = document.getElementById("logout-btn");

  // כפתור יציאה
  logoutBtn.addEventListener("click", () => {
    sessionStorage.removeItem("sb-token");
    window.location.href = "/admin/login";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);


    const token = JSON.parse(session).access_token;

    try {
      // --- שליחה ל-API ---
      const res = await fetch("/api/add-property", {
        method: "POST",
        headers: { 
          Authorization: `Bearer ${token}`,
        },
        body: formData,
      });

      const result = await res.json();

      if (result.success) {
        msg.textContent = "✅ הדירה נוספה בהצלחה!";
        msg.style.color = "green";
        form.reset();
      } else {
        msg.textContent = `❌ שגיאה: ${result.message}`;
        msg.style.color = "red";

        // אם אין הרשאה (403) – הפנייה ל-login
        if (res.status === 403) {
          setTimeout(() => {
            window.location.href = "/admin/login";
          }, 1000);
        }
      }
    } catch (err) {
      console.error(err);
      msg.textContent = "❌ שגיאה בחיבור לשרת";
      msg.style.color = "red";
    }
  });
</script>
</body>
</html>
