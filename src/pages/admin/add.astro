---
import { supabase } from "../../lib/supabaseClient";
import type { Property } from "../../types/property";
---

<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>×”×•×¡×¤×ª ×“×™×¨×” ×—×“×©×”</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body dir="rtl">
<header class="admin-add-header">
  <h1>â• ×”×•×¡×¤×ª ×“×™×¨×” ×—×“×©×”</h1>
  <nav class="admin-nav">
    <a href="/admin/dashboard" class="admin-add-back">â¬…ï¸ ×—×–×¨×” ×œ×“×©×‘×•×¨×“</a>
    <button id="logout-btn" class="admin-logout-btn">ğŸšª ×™×¦×™××”</button>
  </nav>
</header>

<main class="admin-add-main">
  <form id="admin-add-form" class="admin-add-form">
    <!-- ×›×•×ª×¨×ª ×•××—×™×¨ -->
    <label>×›×•×ª×¨×ª:</label>
    <input type="text" name="title" required />

    <label>××—×™×¨:</label>
    <input type="number" name="price" required />

    <!-- ××™×§×•× -->
    <label>×¢×™×¨:</label>
    <input type="text" name="city" required />
    <label>×¨×—×•×‘:</label>
    <input type="text" name="street" />
    <label>××¡×¤×¨:</label>
    <input type="text" name="number" />
    <label>×§×•××”:</label>
    <input type="text" name="floor" />

    <!-- ×ª×™××•×¨ ×•×ª××•× ×•×ª -->
    <label>×ª×™××•×¨:</label>
    <textarea name="description" required></textarea>

    <label>×ª××•× ×•×ª:</label>
    <input type="file" name="images" accept="image/*" multiple />

    <!-- ×¤×¨×˜×™× × ×•×¡×¤×™× -->
    <label>××¡×¤×¨ ×—×“×¨×™×:</label>
    <input type="number" name="bedrooms" />
    <label>××¡×¤×¨ ××™×˜×•×ª:</label>
    <input type="number" name="beds" />
    <label>××¡×¤×¨ ×—×“×¨×™ ×××‘×˜×™×”:</label>
    <input type="number" name="bathrooms" />

    <label>×¡×•×’ × ×›×¡:</label>
    <input type="text" name="type" />

    <label>××˜×‘×—:</label>
    <input type="checkbox" name="kitchen" />
    <label>××›×•× ×ª ×›×‘×™×¡×”:</label>
    <input type="checkbox" name="washingMachine" />
    <label>Wi-Fi:</label>
    <input type="checkbox" name="wifi" />
    <label>×˜×œ×•×•×™×–×™×”:</label>
    <input type="checkbox" name="tv" />
    <label>×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×‘×¡×‘×™×‘×”:</label>
    <input type="checkbox" name="publicTransportNearby" />
    <label>×—× ×™×”:</label>
    <input type="checkbox" name="parking" />

    <label>×©×¢×ª ×›× ×™×¡×”:</label>
    <input type="time" name="checkInTime" />
    <label>×©×¢×ª ×™×¦×™××”:</label>
    <input type="time" name="checkOutTime" />
    <label>××™× ×™××•× ×™××™×:</label>
    <input type="number" name="minStayDays" />

    <button type="submit">×©××•×¨</button>
  </form>

  <p id="admin-add-message"></p>
</main>

<script type="module">
  const form = document.getElementById("admin-add-form");
  const msg = document.getElementById("admin-add-message");
  const logoutBtn = document.getElementById("logout-btn");

  // ×›×¤×ª×•×¨ ×™×¦×™××”
  logoutBtn.addEventListener("click", () => {
    sessionStorage.removeItem("sb-session");
    window.location.href = "/admin/login";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    // ×©×œ×™×¤×ª ×”-session ××”Ö¾sessionStorage
    const session = sessionStorage.getItem("sb-session");
    if (!session) {
      msg.textContent = "âŒ ××™×Ÿ ×”×¨×©××” â€“ ×× × ×”×ª×—×‘×¨ ××—×“×©";
      msg.style.color = "red";
      return;
    }

    const token = JSON.parse(session).access_token;

    try {
      const res = await fetch("/api/add-property", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: formData,
      });

      const result = await res.json();
      if (result.success) {
        msg.textContent = "âœ… ×”×“×™×¨×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!";
        msg.style.color = "green";
        form.reset();
      } else {
        msg.textContent = `âŒ ×©×’×™××”: ${result.message}`;
        msg.style.color = "red";
      }
    } catch (err) {
      console.error(err);
      msg.textContent = "âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª";
      msg.style.color = "red";
    }
  });
</script>
</body>
</html>
