---
import { supabase } from "../lib/supabaseClient";

interface Property {
  id: string;
  title: string;
  price: number;
  location: {
    city: string;
    street: string;
    number: string;
    floor?: string;
  };
  description: string;
  images: string[];
  rooms?: number;
  beds?: number;
  bathrooms?: number;
  type?: string;
  hasKitchen?: boolean;
  hasWashingMachine?: boolean;
  hasWifi?: boolean;
  hasTv?: boolean;
  publicTransport?: boolean;
  parking?: boolean;
  checkIn?: string;
  checkOut?: string;
  minStay?: number;
}

const { params } = Astro;
const id = params.id;

// ×©×œ×™×¤×ª ×”×“×™×¨×” ×œ×¤×™ ××–×”×” ×-Supabase
let property: Property | null = null;

const { data, error } = await supabase
  .from("properties")
  .select("*")
  .eq("id", id)
  .single();

if (error) {
  console.error("×©×’×™××” ×‘×©×œ×™×¤×ª ×”×“×™×¨×”:", error.message);
} else if (data) {
  // ×”××¨×” ×œ××‘× ×” Property
  property = {
    id: data.id,
    title: data.title,
    price: data.price,
    location: {
      city: data.city || data.location || "",
      street: data.street || "",
      number: data.number || "",
      floor: data.floor || "",
    },
    description: data.description,
    images: data.images || [],
    rooms: data.rooms,
    beds: data.beds,
    bathrooms: data.bathrooms,
    type: data.type,
    hasKitchen: data.hasKitchen,
    hasWashingMachine: data.hasWashingMachine,
    hasWifi: data.hasWifi,
    hasTv: data.hasTv,
    publicTransport: data.publicTransport,
    parking: data.parking,
    checkIn: data.checkIn,
    checkOut: data.checkOut,
    minStay: data.minStay,
  };
}

const images = property ? (Array.isArray(property.images) ? property.images : [property.images]) : [];
---
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>{property ? property.title : "×“×™×¨×” ×œ× × ××¦××”"}</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body dir="rtl">
  <header class="detail-header">
    <a href="/" class="detail-back-btn">â¬… ×—×–×¨×” ×œ×¨×©×™××ª ×“×™×¨×•×ª</a>
  </header>

  <main class="detail-container">
    {property ? (
      <>
        <div class="detail-gallery">
          <img id="detailMainImage" src={images[0]} alt={property.title} class="detail-main-image" />
          <div class="detail-thumbs">
            {images.map((img, i) => (
              <img 
                src={img} 
                alt={`×ª××•× ×” ${i+1} ×©×œ ${property.title}`} 
                class="detail-thumb" 
                onclick={`document.getElementById('detailMainImage').src='${img}'`}
              />
            ))}
          </div>
        </div>

        <div class="detail-info">
          <h1 class="detail-title">{property.title}</h1>
          <p class="detail-price">××—×™×¨: {property.price.toLocaleString("he-IL")}</p>

          <h3>××™×§×•×:</h3>
          <p class="detail-location">{property.location.city}, {property.location.street} {property.location.number}{property.location.floor ? `, ×§×•××” ${property.location.floor}` : ""}</p>

          <p class="detail-description">{property.description}</p>

          <ul class="detail-info-list">
            <li>ğŸ› ××¡×¤×¨ ×—×“×¨×™×: {property.rooms}</li>
            <li>ğŸ›Œ ××™×˜×•×ª: {property.beds}</li>
            <li>ğŸš¿ ×—×“×¨×™ ×××‘×˜×™×”: {property.bathrooms}</li>
            <li>ğŸ  ×¡×•×’ × ×›×¡: {property.type}</li>
            <li>ğŸ³ ××˜×‘×—: {property.hasKitchen ? "×›×Ÿ" : "×œ×"}</li>
            <li>ğŸ§º ××›×•× ×ª ×›×‘×™×¡×”: {property.hasWashingMachine ? "×›×Ÿ" : "×œ×"}</li>
            <li>ğŸ“¶ Wi-Fi: {property.hasWifi ? "×›×Ÿ" : "×œ×"}</li>
            <li>ğŸ“º ×˜×œ×•×•×™×–×™×”: {property.hasTv ? "×›×Ÿ" : "×œ×"}</li>
            <li>ğŸšŒ ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×‘×¡×‘×™×‘×”: {property.publicTransport ? "×›×Ÿ" : "×œ×"}</li>
            <li>ğŸš— ×—× ×™×”: {property.parking ? "×›×Ÿ" : "×œ×"}</li>
            <li>â° ×©×¢×ª ×›× ×™×¡×”: {property.checkIn}</li>
            <li>â° ×©×¢×ª ×™×¦×™××”: {property.checkOut}</li>
            <li>ğŸ—“ ××™× ×™××•× ×”×–×× ×” ×‘×™××™×: {property.minStay}</li>
          </ul>
        </div>
      </>
    ) : (
      <p class="detail-not-found">×“×™×¨×” ×–×• ×œ× ×§×™×™××ª.</p>
    )}
  </main>
</body>
</html>
