---
import { supabase } from "../../lib/supabaseClient";
import i18next from '../../i18n.js';

// ×‘×“×™×§×ª ×”×¨×©××•×ª ×ª×ª×‘×¦×¢ ×‘×¦×“ ×”×œ×§×•×—
---
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <title>â• {i18next.t("admin.addNewProperty")}</title>
    <link rel="stylesheet" href="/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/js/i18n.js" is:inline></script>
  </head>
  <body dir="rtl">
    <header class="admin-header">
      <div class="admin-header-content">
        <h1 class="admin-title">
          <span class="admin-icon">â•</span>
          {i18next.t("admin.addNewProperty")}
        </h1>
        <nav class="admin-nav">
          <a href="/admin/dashboard" class="admin-nav-btn back-btn">
            <span class="btn-icon">â¬…ï¸</span>
            {i18next.t("admin.backToDashboard")}
          </a>
          <button id="logout-btn" class="admin-nav-btn logout-btn">
            <span class="btn-icon">ğŸšª</span>
            {i18next.t("admin.logout")}
          </button>
        </nav>
      </div>
    </header>

    <main class="admin-main">
      <div class="admin-container">
        <form id="admin-add-form" class="admin-form">
          <!-- ×›×•×ª×¨×ª ×•××—×™×¨ -->
          <div class="form-section">
            <h2 class="section-title">ğŸ“ {i18next.t("admin.basicInfo")}</h2>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="title">{i18next.t("admin.title")} *</label>
                <input type="text" id="title" name="title" class="form-input" required placeholder={i18next.t("admin.enterTitle")} />
              </div>
              <div class="form-group">
                <label class="form-label" for="price">{i18next.t("admin.pricePerNight")} *</label>
                <input type="number" id="price" name="price" class="form-input" required placeholder="0" min="0" />
                <span class="currency">â‚ª</span>
              </div>
            </div>
          </div>

          <!-- ××™×§×•× -->
          <div class="form-section">
            <h2 class="section-title">ğŸ“ {i18next.t("admin.location")}</h2>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="city">{i18next.t("admin.city")} *</label>
                <input type="text" id="city" name="city" class="form-input" required placeholder={i18next.t("property.enterCity")} />
              </div>
              <div class="form-group">
                <label class="form-label" for="street">{i18next.t("admin.street")}</label>
                <input type="text" id="street" name="street" class="form-input" placeholder={i18next.t("property.enterStreet")} />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="number">{i18next.t("admin.number")}</label>
                <input type="text" id="number" name="number" class="form-input" placeholder={i18next.t("property.enterNumber")} />
              </div>
              <div class="form-group">
                <label class="form-label" for="floor">{i18next.t("admin.floor")}</label>
                <input type="text" id="floor" name="floor" class="form-input" placeholder={i18next.t("property.enterFloor")} />
              </div>
            </div>
          </div>

          <!-- ×ª×™××•×¨ ×•×ª××•× ×•×ª -->
          <div class="form-section">
            <h2 class="section-title">ğŸ“„ {i18next.t("admin.description")}</h2>
            <div class="form-group">
              <label class="form-label" for="description">{i18next.t("admin.description")} *</label>
              <textarea id="description" name="description" class="form-textarea" required placeholder={i18next.t("property.enterDescription")}></textarea>
            </div>
          </div>

          <div class="form-section">
            <h2 class="section-title">ğŸ–¼ï¸ {i18next.t("admin.images")}</h2>
            <div class="form-group">
              <label class="form-label" for="images">{i18next.t("admin.images")} *</label>
              <div class="file-upload-container">
                <input type="file" id="images" name="images" accept="image/*" multiple class="file-input" />
                <label for="images" class="file-upload-label">
                  <span class="file-upload-icon">ğŸ“</span>
                  <span class="file-upload-text">×‘×—×¨ ×ª××•× ×•×ª</span>
                </label>
                <div class="file-preview" id="file-preview"></div>
              </div>
            </div>
          </div>

          <!-- ×¤×¨×˜×™× × ×•×¡×¤×™× -->
          <div class="form-section">
            <h2 class="section-title">ğŸ›ï¸ {i18next.t("admin.propertyDetails")}</h2>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="bedrooms">{i18next.t("admin.bedrooms")}</label>
                <input type="number" id="bedrooms" name="bedrooms" class="form-input" min="0" placeholder="0" />
              </div>
              <div class="form-group">
                <label class="form-label" for="beds">{i18next.t("admin.beds")}</label>
                <input type="number" id="beds" name="beds" class="form-input" min="0" placeholder="0" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="bathrooms">{i18next.t("admin.bathrooms")}</label>
                <input type="number" id="bathrooms" name="bathrooms" class="form-input" min="0" placeholder="0" />
              </div>
              <div class="form-group">
                <label class="form-label" for="occupancy">{i18next.t("admin.maxOccupancy")}</label>
                <input type="number" id="occupancy" name="occupancy" class="form-input" min="1" placeholder="1" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="type">{i18next.t("admin.propertyType")}</label>
              <select id="type" name="type" class="form-select">
                <option value="">{i18next.t("property.selectPropertyType")}</option>
                <option value={i18next.t("property.apartment")}>{i18next.t("property.apartment")}</option>
                <option value={i18next.t("property.house")}>{i18next.t("property.house")}</option>
                <option value={i18next.t("property.villa")}>{i18next.t("property.villa")}</option>
                <option value={i18next.t("property.cabin")}>{i18next.t("property.cabin")}</option>
                <option value={i18next.t("property.hotel")}>{i18next.t("property.hotel")}</option>
              </select>
            </div>
          </div>

          <!-- ××ª×§× ×™× -->
          <div class="form-section">
            <h2 class="section-title">âš™ï¸ {i18next.t("admin.amenities")}</h2>
            <div class="amenities-grid">
              <div class="amenity-category">
                <h3 class="amenity-category-title">××ª×§× ×™× ×›×œ×œ×™×™×</h3>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" name="kitchen" class="checkbox-input" />
                    <span class="checkbox-text">ğŸ³ {i18next.t("admin.kitchen")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="washingmachine" class="checkbox-input" />
                    <span class="checkbox-text">ğŸ§º {i18next.t("admin.washingmachine")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="wifi" class="checkbox-input" />
                    <span class="checkbox-text">ğŸ“¶ {i18next.t("admin.wifi")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="tv" class="checkbox-input" />
                    <span class="checkbox-text">ğŸ“º {i18next.t("admin.tv")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="parking" class="checkbox-input" />
                    <span class="checkbox-text">ğŸ…¿ï¸ {i18next.t("admin.parking")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="publictransportnearby" class="checkbox-input" />
                    <span class="checkbox-text">ğŸšŒ {i18next.t("admin.publictransportnearby")}</span>
                  </label>
                </div>
              </div>
              
              <div class="amenity-category">
                <h3 class="amenity-category-title">××ª×§× ×™× ×—×™×¦×•× ×™×™×</h3>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" name="has_pool" class="checkbox-input" />
                    <span class="checkbox-text">ğŸŠ {i18next.t("admin.pool")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="has_private_pool" class="checkbox-input" />
                    <span class="checkbox-text">ğŸŠâ€â™€ï¸ {i18next.t("admin.privatePool")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="has_jacuzzi" class="checkbox-input" />
                    <span class="checkbox-text">ğŸ› {i18next.t("admin.jacuzzi")}</span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" name="has_grill" class="checkbox-input" />
                    <span class="checkbox-text">ğŸ”¥ {i18next.t("admin.grill")}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- ×¤×¨×˜×™ ×™×¦×™×¨×ª ×§×©×¨ -->
          <div class="form-section">
            <h2 class="section-title">ğŸ“ {i18next.t("admin.contactInfo")}</h2>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="phone">{i18next.t("admin.phone")}</label>
                <input type="tel" id="phone" name="phone" class="form-input" placeholder="050-1234567" pattern="0[0-9]{8,9}" title={i18next.t("property.phoneValidation")} />
              </div>
              <div class="form-group">
                <label class="form-label" for="whatsapp">{i18next.t("admin.whatsapp")}</label>
                <input type="tel" id="whatsapp" name="whatsapp" class="form-input" placeholder="050-1234567" pattern="0[0-9]{8,9}" title={i18next.t("property.whatsappValidation")} />
              </div>
            </div>
          </div>

          <!-- ×ª× ××™× -->
          <div class="form-section">
            <h2 class="section-title">â° {i18next.t("admin.terms")}</h2>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="checkInTime">{i18next.t("admin.checkInTime")}</label>
                <input type="time" id="checkInTime" name="checkInTime" class="form-input" />
              </div>
              <div class="form-group">
                <label class="form-label" for="checkOutTime">{i18next.t("admin.checkOutTime")}</label>
                <input type="time" id="checkOutTime" name="checkOutTime" class="form-input" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="minstaydays">{i18next.t("admin.minstaydays")}</label>
              <input type="number" id="minstaydays" name="minstaydays" class="form-input" min="1" placeholder="1" />
            </div>
          </div>

          <!-- ×§×˜×’×•×¨×™×•×ª -->
          <div class="form-section">
            <h2 class="section-title">ğŸ¯ {i18next.t("admin.suitableFor")}</h2>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="suitable_for" value={i18next.t("admin.families")} class="checkbox-input" />
                <span class="checkbox-text">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ {i18next.t("admin.families")}</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="suitable_for" value={i18next.t("admin.religious")} class="checkbox-input" />
                <span class="checkbox-text">ğŸ• {i18next.t("admin.religious")}</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="suitable_for" value={i18next.t("admin.groups")} class="checkbox-input" />
                <span class="checkbox-text">ğŸ‘¥ {i18next.t("admin.groups")}</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="suitable_for" value={i18next.t("admin.couples")} class="checkbox-input" />
                <span class="checkbox-text">ğŸ’‘ {i18next.t("admin.couples")}</span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <h2 class="section-title">ğŸ“ {i18next.t("admin.nearby")}</h2>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="nearby" value={i18next.t("admin.synagogue")} class="checkbox-input" />
                <span class="checkbox-text">ğŸ• {i18next.t("admin.synagogue")}</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="nearby" value={i18next.t("admin.restaurants")} class="checkbox-input" />
                <span class="checkbox-text">ğŸ½ï¸ {i18next.t("admin.restaurants")}</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="nearby" value={i18next.t("admin.shoppingCenter")} class="checkbox-input" />
                <span class="checkbox-text">ğŸ›ï¸ {i18next.t("admin.shoppingCenter")}</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" name="nearby" value={i18next.t("admin.publicTransport")} class="checkbox-input" />
                <span class="checkbox-text">ğŸšŒ {i18next.t("admin.publicTransport")}</span>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="submit-btn">
              <span class="btn-icon">ğŸ’¾</span>
              {i18next.t("admin.save")}
            </button>
            <button type="reset" class="reset-btn">
              <span class="btn-icon">ğŸ”„</span>
              ××™×¤×•×¡ ×˜×•×¤×¡
            </button>
          </div>
        </form>

        <div id="admin-add-message" class="message-container"></div>
      </div>
    </main>


    <script type="module">
      // ×©×™××•×© ×‘-i18n ×©×›×‘×¨ ×××•×ª×—×œ ×‘×¦×“ ×”×©×¨×ª
      // @ts-ignore
      const i18next = window.i18next || {
        t: (key) => key // fallback ×× i18n ×œ× ×–××™×Ÿ
      };

      // ×‘×“×™×§×ª ×”×¨×©××•×ª ×× ×”×œ
      const session = JSON.parse(sessionStorage.getItem("sb-session") || "{}");
      console.log("Session data:", session);
      if (!session.access_token) {
        console.log("No access token found, redirecting to login");
        alert(window.i18next.t("admin.noPermission"));
        window.location.href = "/admin/login";
      } else {
        console.log("Access token found:", session.access_token.substring(0, 20) + "...");
      }

      // ×©×™××•×© ×‘×ª×¨×’×•××™× ×-i18n ×”×’×œ×•×‘×œ×™

      const form = document.getElementById("admin-add-form");
      const msg = document.getElementById("admin-add-message");
      const logoutBtn = document.getElementById("logout-btn");
      const fileInput = document.getElementById("images");
      const filePreview = document.getElementById("file-preview");

      // ×›×¤×ª×•×¨ ×™×¦×™××”
      logoutBtn.addEventListener("click", () => {
        sessionStorage.removeItem("sb-session");
        window.location.href = "/admin/login";
      });

      // ×ª×¦×•×’×ª ×ª××•× ×•×ª ××§×“×™××”
      fileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        filePreview.innerHTML = "";
        
        files.forEach((file, index) => {
          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const preview = document.createElement("div");
              preview.className = "file-preview-item";
              preview.innerHTML = `
                <img src="${e.target.result}" alt="×ª×¦×•×’×” ××§×“×™××” ${index + 1}" />
                <span class="file-name">${file.name}</span>
                <button type="button" class="remove-file" data-index="${index}">Ã—</button>
              `;
              filePreview.appendChild(preview);
            };
            reader.readAsDataURL(file);
          }
        });
      });

      // ×”×¡×¨×ª ×ª××•× ×” ××ª×¦×•×’×” ××§×“×™××”
      filePreview.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-file")) {
          const index = parseInt(e.target.dataset.index);
          const dt = new DataTransfer();
          const files = Array.from(fileInput.files);
          files.splice(index, 1);
          files.forEach(file => dt.items.add(file));
          fileInput.files = dt.files;
          e.target.closest(".file-preview-item").remove();
        }
      });

      // ××™×¤×•×¡ ×˜×•×¤×¡
      document.querySelector(".reset-btn").addEventListener("click", () => {
        form.reset();
        filePreview.innerHTML = "";
        msg.textContent = "";
        msg.className = "message-container";
      });

      // ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×˜×œ×¤×•×Ÿ
      function validatePhone(phone) {
        const phoneRegex = /^0[0-9]{8,9}$/;
        return phoneRegex.test(phone.replace(/-/g, ""));
      }

      // ×”×¦×’×ª ×”×•×“×¢×ª ×©×’×™××”
      function showError(message) {
        msg.textContent = message;
        msg.className = "message-container error";
      }

      // ×”×¦×’×ª ×”×•×“×¢×ª ×”×¦×œ×—×”
      function showSuccess(message) {
        msg.textContent = message;
        msg.className = "message-container success";
      }

      // ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
      function showLoading(message) {
        msg.textContent = message;
        msg.className = "message-container loading";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // ×‘×“×™×§×ª ×©×“×•×ª ×—×•×‘×”
        const requiredFields = ["title", "price", "city", "description"];
        for (const field of requiredFields) {
          if (!form[field].value.trim()) {
            showError(window.i18next.t("common.errors.fillAllFieldsRequired"));
            form[field].focus();
            return;
          }
        }

        // ×‘×“×™×§×ª ×ª××•× ×•×ª
        if (fileInput.files.length === 0) {
          showError(window.i18next.t("property.selectAtLeastOneImage"));
          return;
        }

        // ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×˜×œ×¤×•×Ÿ
        if (form.phone.value && !validatePhone(form.phone.value)) {
          showError(window.i18next.t("common.errors.invalidPhone"));
          form.phone.focus();
          return;
        }

        if (form.whatsapp.value && !validatePhone(form.whatsapp.value)) {
          showError(window.i18next.t("common.errors.invalidPhone"));
          form.whatsapp.focus();
          return;
        }

        showLoading(window.i18next.t("common.messages.sendingData"));

        const formData = new FormData(form);

        // ××™×¡×•×£ ×›×œ ×”-checkboxes ××¡×•×’ suitableFor ×•-nearby ×›××¢×¨×›×™×
        const suitableFor = Array.from(
          form.querySelectorAll('input[name="suitable_for"]:checked'),
        ).map((cb) => cb.value);
        const nearby = Array.from(
          form.querySelectorAll('input[name="nearby"]:checked'),
        ).map((cb) => cb.value);

        formData.append("suitable_for", JSON.stringify(suitableFor));
        formData.append("nearby", JSON.stringify(nearby));

        // ×‘×“×™×§×ª MIME type ×©×œ ×”×ª××•× ×•×ª
        const allowedMimeTypes = [
          "image/jpeg",
          "image/png",
          "image/gif",
          "image/webp",
        ];
        const files = Array.from(fileInput.files);

        for (const file of files) {
          if (!allowedMimeTypes.includes(file.type)) {
            showError(`${window.i18next.t("admin.errorFileType")} ${file.name}. ${window.i18next.t("admin.onlyImagesSupported")}`);
            return;
          }
        }

        // ×§×‘×œ×ª ×”×˜×•×§×Ÿ ××”-sessionStorage
        const session = sessionStorage.getItem("sb-session");
        if (!session) {
          showError(window.i18next.t("admin.noPermission"));
          setTimeout(() => {
            window.location.href = "/admin/login";
          }, 3000);
          return;
        }

        const token = JSON.parse(session).access_token;

        try {
          console.log("Sending request to /api/add-property with token:", token.substring(0, 20) + "...");
          const res = await fetch("/api/add-property", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          console.log("Response status:", res.status);
          const result = await res.json();
          console.log("Response result:", result);

          if (result.success) {
            showSuccess(window.i18next.t("common.success.propertyAdded"));
            form.reset();
            filePreview.innerHTML = "";
            // ×’×œ×™×œ×” ×œ××¢×œ×”
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            showError(`${window.i18next.t("common.errors.error")} ${result.message}`);
            if (res.status === 403) {
              setTimeout(() => {
                window.location.href = "/admin/login";
              }, 3000);
            }
          }
        } catch (err) {
          console.error(err);
          showError(window.i18next.t("common.errors.connectionError"));
        }
      });
    </script>
  </body>
</html>